<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>電子契約作成・CloudSign連携 - SES業務システム</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    
    <!-- カスタムCSS -->
    <style>
        :root {
            --sidebar-width: 280px;
            --header-height: 60px;
            --ses-primary: #0d6efd;
            --ses-secondary: #6c757d;
            --ses-success: #198754;
            --ses-warning: #ffc107;
            --ses-danger: #dc3545;
            --ses-light: #f8f9fa;
        }
        
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: var(--header-height);
            min-height: calc(100vh - var(--header-height));
        }
        
        .sidebar {
            position: fixed;
            top: var(--header-height);
            left: 0;
            width: var(--sidebar-width);
            height: calc(100vh - var(--header-height));
            background-color: #212529;
            z-index: 1000;
        }
        
        .navbar {
            height: var(--header-height);
            background-color: #ffffff !important;
            border-bottom: 1px solid #dee2e6;
        }
        
        .step-wizard {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        
        .step {
            display: flex;
            align-items: center;
            position: relative;
            margin: 0 1rem;
        }
        
        .step-indicator {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }
        
        .step.active .step-indicator {
            background: var(--ses-primary);
            color: white;
        }
        
        .step.completed .step-indicator {
            background: var(--ses-success);
            color: white;
        }
        
        .step-label {
            position: absolute;
            top: 45px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .step.active .step-label {
            color: var(--ses-primary);
            font-weight: 500;
        }
        
        .step.completed .step-label {
            color: var(--ses-success);
        }
        
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 40px;
            width: 60px;
            height: 2px;
            background: #e9ecef;
            z-index: 1;
        }
        
        .step.completed:not(:last-child)::after {
            background: var(--ses-success);
        }
        
        .form-step {
            display: none;
        }
        
        .form-step.active {
            display: block;
        }
        
        .template-selector {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .template-selector:hover {
            border-color: var(--ses-primary);
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.1);
        }
        
        .template-selector.selected {
            border-color: var(--ses-primary);
            background: rgba(13, 110, 253, 0.05);
        }
        
        .contract-editor {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            min-height: 400px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            background: #f8f9fa;
        }
        
        .signer-card {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .signer-card:hover {
            border-color: var(--ses-primary);
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.1);
        }
        
        .cloudsign-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
        }
        
        .cloudsign-connected {
            background: #e8f5e8;
            border: 1px solid var(--ses-success);
            color: var(--ses-success);
        }
        
        .cloudsign-pending {
            background: #fff3e0;
            border: 1px solid var(--ses-warning);
            color: var(--ses-warning);
        }
        
        .cloudsign-error {
            background: #ffebee;
            border: 1px solid var(--ses-danger);
            color: var(--ses-danger);
        }
        
        .progress-tracker {
            position: sticky;
            top: 20px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1.5rem;
        }
        
        .variable-tag {
            background: #e3f2fd;
            color: #1565c0;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            cursor: pointer;
            margin: 0.125rem;
            display: inline-block;
        }
        
        .variable-tag:hover {
            background: #bbdefb;
        }
        
        .signature-field {
            border: 2px dashed #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            text-align: center;
            margin: 0.5rem 0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
        }
        
        .signature-field.positioned {
            border-color: var(--ses-primary);
            background: rgba(13, 110, 253, 0.05);
        }
        
        .connection-test {
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        
        .connection-success {
            border-color: var(--ses-success);
            background: #e8f5e8;
        }
        
        .connection-error {
            border-color: var(--ses-danger);
            background: #ffebee;
        }
        
        .preview-container {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 2rem;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .document-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #333;
        }
        
        .document-content {
            line-height: 1.8;
            font-size: 1rem;
        }
        
        .signature-placeholder {
            border: 1px solid #ccc;
            background: #f9f9f9;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
            position: relative;
        }
        
        .signature-info {
            position: absolute;
            top: -10px;
            left: 10px;
            background: white;
            padding: 0 0.5rem;
            font-size: 0.75rem;
            color: #666;
        }
        
        .send-progress {
            display: none;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            margin-top: 1rem;
        }
        
        .send-progress.active {
            display: block;
        }
        
        .log-entry {
            padding: 0.5rem;
            margin: 0.25rem 0;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
        
        .log-info {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .log-success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .log-error {
            background: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body x-data="contractCreation" x-cloak>
    
    <!-- ヘッダー -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container-fluid">
            <button class="btn btn-outline-secondary me-3" @click="toggleSidebar()">
                <i class="bi bi-list"></i>
            </button>
            <a class="navbar-brand" href="#">SES業務システム</a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle me-1"></i>山田太郎
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>プロフィール</a></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>設定</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-box-arrow-right me-2"></i>ログアウト</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- サイドバー -->
    <nav class="sidebar text-white">
        <div class="p-3">
            <ul class="nav nav-pills flex-column">
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-briefcase me-2"></i>案件管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-people me-2"></i>技術者管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-search-heart me-2"></i>マッチング
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white active" href="#">
                        <i class="bi bi-file-earmark-text me-2"></i>契約管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-clock me-2"></i>勤怠管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-receipt me-2"></i>請求管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-graph-up me-2"></i>レポート
                    </a>
                </li>
            </ul>
        </div>
    </nav>
    
    <!-- メインコンテンツ -->
    <main class="main-content">
        <div class="container-fluid p-4">
            <!-- ページヘッダー -->
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" class="text-decoration-none">契約管理</a></li>
                            <li class="breadcrumb-item active" aria-current="page">電子契約作成</li>
                        </ol>
                    </nav>
                    <h1 class="h3 mb-2">電子契約作成・CloudSign連携</h1>
                    <p class="text-muted mb-0">契約書の作成からCloudSignでの電子署名まで一気通貫で実行</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary" @click="saveDraft()" :disabled="currentStep === 5">
                        <i class="bi bi-bookmark me-1"></i>下書き保存
                    </button>
                    <button class="btn btn-outline-danger" @click="cancelCreation()">
                        <i class="bi bi-x me-1"></i>キャンセル
                    </button>
                </div>
            </div>
            
            <!-- ステップウィザード -->
            <div class="step-wizard">
                <div class="step" :class="{ active: currentStep === 1, completed: currentStep > 1 }">
                    <div class="step-indicator">
                        <i x-show="currentStep > 1" class="bi bi-check"></i>
                        <span x-show="currentStep <= 1">1</span>
                    </div>
                    <div class="step-label">テンプレート選択</div>
                </div>
                <div class="step" :class="{ active: currentStep === 2, completed: currentStep > 2 }">
                    <div class="step-indicator">
                        <i x-show="currentStep > 2" class="bi bi-check"></i>
                        <span x-show="currentStep <= 2">2</span>
                    </div>
                    <div class="step-label">契約内容編集</div>
                </div>
                <div class="step" :class="{ active: currentStep === 3, completed: currentStep > 3 }">
                    <div class="step-indicator">
                        <i x-show="currentStep > 3" class="bi bi-check"></i>
                        <span x-show="currentStep <= 3">3</span>
                    </div>
                    <div class="step-label">署名者設定</div>
                </div>
                <div class="step" :class="{ active: currentStep === 4, completed: currentStep > 4 }">
                    <div class="step-indicator">
                        <i x-show="currentStep > 4" class="bi bi-check"></i>
                        <span x-show="currentStep <= 4">4</span>
                    </div>
                    <div class="step-label">プレビュー・確認</div>
                </div>
                <div class="step" :class="{ active: currentStep === 5, completed: currentStep > 5 }">
                    <div class="step-indicator">5</div>
                    <div class="step-label">CloudSign送信</div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <!-- ステップ1: テンプレート選択 -->
                        <div class="form-step" :class="{ active: currentStep === 1 }">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-file-earmark-text me-2"></i>契約書テンプレート選択
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <template x-for="template in contractTemplates" :key="template.id">
                                        <div class="col-md-6 mb-3">
                                            <div class="template-selector" 
                                                 :class="{ selected: selectedTemplate?.id === template.id }"
                                                 @click="selectTemplate(template)">
                                                <div class="d-flex align-items-start">
                                                    <div class="me-3">
                                                        <i class="bi" :class="template.icon" style="font-size: 2rem; color: var(--ses-primary);"></i>
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <h6 class="mb-1" x-text="template.name"></h6>
                                                        <p class="text-muted small mb-2" x-text="template.description"></p>
                                                        <div class="d-flex align-items-center gap-3">
                                                            <span class="badge bg-light text-dark" x-text="template.category"></span>
                                                            <span class="small text-muted">
                                                                <i class="bi bi-clock me-1"></i>
                                                                <span x-text="template.estimatedTime"></span>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- カスタムテンプレート -->
                                <div class="mt-4">
                                    <h6>カスタムテンプレート</h6>
                                    <div class="template-selector" 
                                         :class="{ selected: selectedTemplate?.id === 'custom' }"
                                         @click="selectCustomTemplate()">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-file-earmark-plus me-3" style="font-size: 2rem; color: var(--ses-secondary);"></i>
                                            <div>
                                                <h6 class="mb-1">独自契約書作成</h6>
                                                <p class="text-muted small mb-0">白紙の状態から契約書を作成します</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ステップ2: 契約内容編集 -->
                        <div class="form-step" :class="{ active: currentStep === 2 }">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-pencil me-2"></i>契約内容編集
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- 基本情報入力 -->
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label">契約名 <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" x-model="contractData.name" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">契約種別</label>
                                        <select class="form-select" x-model="contractData.type">
                                            <option value="EMPLOYMENT_AGREEMENT">準委任契約</option>
                                            <option value="SUBCONTRACT_AGREEMENT">請負契約</option>
                                            <option value="CONSULTING_AGREEMENT">コンサルティング契約</option>
                                            <option value="DISPATCH_AGREEMENT">派遣契約</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">契約開始日 <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" x-model="contractData.startDate" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">契約終了日</label>
                                        <input type="date" class="form-control" x-model="contractData.endDate">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">契約金額</label>
                                        <input type="number" class="form-control" x-model="contractData.amount">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">技術者</label>
                                        <select class="form-select" x-model="contractData.engineerId">
                                            <option value="">選択してください</option>
                                            <template x-for="engineer in engineers" :key="engineer.id">
                                                <option :value="engineer.id" x-text="engineer.name"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- 変数挿入パレット -->
                                <div class="mb-3">
                                    <h6>変数挿入</h6>
                                    <div class="p-2 border rounded bg-light">
                                        <template x-for="variable in contractVariables" :key="variable.key">
                                            <span class="variable-tag" @click="insertVariable(variable)" x-text="`{{${variable.key}}}`"></span>
                                        </template>
                                    </div>
                                </div>
                                
                                <!-- 契約書編集エリア -->
                                <div class="mb-3">
                                    <label class="form-label">契約書本文</label>
                                    <textarea class="form-control contract-editor" 
                                              x-model="contractData.content" 
                                              rows="15"
                                              placeholder="契約書の内容を入力してください..."></textarea>
                                </div>
                                
                                <!-- 署名欄配置 -->
                                <div class="mb-3">
                                    <h6>署名欄配置</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="signature-field" @click="addSignatureField('client')">
                                                <div class="text-muted">
                                                    <i class="bi bi-plus-circle me-2"></i>発注者署名欄
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="signature-field" @click="addSignatureField('contractor')">
                                                <div class="text-muted">
                                                    <i class="bi bi-plus-circle me-2"></i>受託者署名欄
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ステップ3: 署名者設定 -->
                        <div class="form-step" :class="{ active: currentStep === 3 }">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-people me-2"></i>署名者設定
                                </h5>
                            </div>
                            <div class="card-body">
                                <template x-for="(signer, index) in contractData.signers" :key="index">
                                    <div class="signer-card">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="mb-0">署名者 <span x-text="index + 1"></span></h6>
                                            <button class="btn btn-outline-danger btn-sm" @click="removeSigner(index)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">氏名 <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" x-model="signer.name" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">メールアドレス <span class="text-danger">*</span></label>
                                                <input type="email" class="form-control" x-model="signer.email" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">役職・立場</label>
                                                <input type="text" class="form-control" x-model="signer.title">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">署名順序</label>
                                                <select class="form-select" x-model="signer.order">
                                                    <option value="1">1番目</option>
                                                    <option value="2">2番目</option>
                                                    <option value="3">3番目</option>
                                                    <option value="4">4番目</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">認証方法</label>
                                                <select class="form-select" x-model="signer.authMethod">
                                                    <option value="email">メール認証</option>
                                                    <option value="sms">SMS認証</option>
                                                    <option value="both">メール + SMS</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">署名期限（日数）</label>
                                                <input type="number" class="form-control" x-model="signer.deadline" min="1" max="30" value="7">
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label">署名依頼メッセージ</label>
                                                <textarea class="form-control" x-model="signer.message" rows="3" 
                                                          placeholder="署名依頼時に送信されるメッセージを入力してください"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                
                                <button class="btn btn-outline-primary" @click="addSigner()">
                                    <i class="bi bi-plus me-1"></i>署名者追加
                                </button>
                            </div>
                        </div>
                        
                        <!-- ステップ4: プレビュー・確認 -->
                        <div class="form-step" :class="{ active: currentStep === 4 }">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-eye me-2"></i>プレビュー・確認
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="preview-container">
                                    <div class="document-header">
                                        <h3 x-text="contractData.name || '契約書'"></h3>
                                        <div class="text-muted">
                                            作成日: <span x-text="formatDate(new Date())"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="document-content" x-html="getPreviewContent()"></div>
                                    
                                    <!-- 署名欄プレビュー -->
                                    <div class="mt-4">
                                        <template x-for="(signer, index) in contractData.signers" :key="index">
                                            <div class="signature-placeholder">
                                                <div class="signature-info" x-text="`署名者${index + 1}`"></div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <strong>氏名:</strong> <span x-text="signer.name"></span><br>
                                                        <strong>役職:</strong> <span x-text="signer.title"></span>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <strong>署名日:</strong> _______________<br>
                                                        <strong>署名:</strong> _______________
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                                
                                <!-- 確認事項 -->
                                <div class="alert alert-info">
                                    <h6><i class="bi bi-info-circle me-2"></i>送信前の確認事項</h6>
                                    <ul class="mb-0">
                                        <li>契約内容に間違いがないかご確認ください</li>
                                        <li>署名者のメールアドレスが正しいかご確認ください</li>
                                        <li>CloudSignへの送信後は内容の変更ができません</li>
                                        <li>署名依頼メールが各署名者に送信されます</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ステップ5: CloudSign送信 -->
                        <div class="form-step" :class="{ active: currentStep === 5 }">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-cloud me-2"></i>CloudSign送信
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- CloudSign接続テスト -->
                                <div class="connection-test" :class="{ 'connection-success': cloudSignConnected, 'connection-error': !cloudSignConnected }">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <i class="bi" :class="cloudSignConnected ? 'bi-check-circle text-success' : 'bi-x-circle text-danger'" style="font-size: 1.5rem; margin-right: 1rem;"></i>
                                            <div>
                                                <h6 class="mb-1">CloudSign接続状況</h6>
                                                <div class="small" x-text="cloudSignConnected ? 'CloudSignとの接続が確認できました' : 'CloudSignとの接続に失敗しました'"></div>
                                            </div>
                                        </div>
                                        <button class="btn btn-outline-secondary btn-sm" @click="testCloudSignConnection()">
                                            <i class="bi bi-arrow-clockwise me-1"></i>接続テスト
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 送信設定 -->
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label">文書タイトル</label>
                                        <input type="text" class="form-control" x-model="cloudSignSettings.title" :value="contractData.name">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">有効期限（日数）</label>
                                        <input type="number" class="form-control" x-model="cloudSignSettings.expireDays" min="1" max="365" value="30">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">送信時メッセージ</label>
                                        <textarea class="form-control" x-model="cloudSignSettings.message" rows="3" 
                                                  placeholder="署名依頼送信時のメッセージを入力してください"></textarea>
                                    </div>
                                </div>
                                
                                <!-- 送信オプション -->
                                <div class="mb-4">
                                    <h6>送信オプション</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" x-model="cloudSignSettings.autoReminder">
                                        <label class="form-check-label">自動リマインダー送信</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" x-model="cloudSignSettings.downloadProtection">
                                        <label class="form-check-label">ダウンロード制限</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" x-model="cloudSignSettings.viewNotification">
                                        <label class="form-check-label">閲覧通知</label>
                                    </div>
                                </div>
                                
                                <!-- 送信進捗 -->
                                <div class="send-progress" :class="{ active: sending }">
                                    <h6><i class="bi bi-cloud-upload me-2"></i>CloudSignに送信中...</h6>
                                    <div class="progress mb-3">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             :style="`width: ${sendProgress}%`"></div>
                                    </div>
                                    <div class="log-container" style="max-height: 200px; overflow-y: auto;">
                                        <template x-for="log in sendLogs" :key="log.id">
                                            <div class="log-entry" :class="`log-${log.type}`" x-text="log.message"></div>
                                        </template>
                                    </div>
                                </div>
                                
                                <!-- 送信結果 -->
                                <div x-show="sendCompleted && !sendError" class="alert alert-success">
                                    <h6><i class="bi bi-check-circle me-2"></i>CloudSign送信完了</h6>
                                    <p class="mb-0">契約書がCloudSignに正常に送信されました。各署名者に署名依頼メールが送信されます。</p>
                                    <div class="mt-2">
                                        <strong>文書ID:</strong> <span x-text="cloudSignDocumentId"></span>
                                    </div>
                                </div>
                                
                                <div x-show="sendError" class="alert alert-danger">
                                    <h6><i class="bi bi-x-circle me-2"></i>送信エラー</h6>
                                    <p class="mb-0" x-text="sendErrorMessage"></p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- フォームアクション -->
                        <div class="card-footer">
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-secondary" @click="previousStep()" x-show="currentStep > 1 && !sending">
                                    <i class="bi bi-arrow-left me-1"></i>前へ
                                </button>
                                <div class="ms-auto d-flex gap-2">
                                    <button type="button" class="btn btn-primary" @click="nextStep()" 
                                            x-show="currentStep < 4" :disabled="!canProceed()">
                                        次へ <i class="bi bi-arrow-right ms-1"></i>
                                    </button>
                                    <button type="button" class="btn btn-warning" @click="nextStep()" 
                                            x-show="currentStep === 4">
                                        送信設定へ <i class="bi bi-arrow-right ms-1"></i>
                                    </button>
                                    <button type="button" class="btn btn-success" @click="sendToCloudSign()" 
                                            x-show="currentStep === 5" :disabled="!cloudSignConnected || sending">
                                        <i class="bi bi-cloud-upload me-1"></i>CloudSignに送信
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- サイドバー - 進捗・ヘルプ -->
                <div class="col-lg-4">
                    <div class="progress-tracker">
                        <h6><i class="bi bi-list-check me-2"></i>作成進捗</h6>
                        <div class="progress mb-3">
                            <div class="progress-bar" :style="`width: ${getProgressPercentage()}%`"></div>
                        </div>
                        
                        <div class="small">
                            <div class="d-flex justify-content-between mb-2">
                                <span>テンプレート選択</span>
                                <i class="bi" :class="currentStep > 1 ? 'bi-check-circle text-success' : 'bi-circle'"></i>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>契約内容編集</span>
                                <i class="bi" :class="currentStep > 2 ? 'bi-check-circle text-success' : 'bi-circle'"></i>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>署名者設定</span>
                                <i class="bi" :class="currentStep > 3 ? 'bi-check-circle text-success' : 'bi-circle'"></i>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>プレビュー確認</span>
                                <i class="bi" :class="currentStep > 4 ? 'bi-check-circle text-success' : 'bi-circle'"></i>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>CloudSign送信</span>
                                <i class="bi" :class="sendCompleted ? 'bi-check-circle text-success' : 'bi-circle'"></i>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <h6><i class="bi bi-info-circle me-2"></i>ヘルプ・ガイド</h6>
                        <div class="small text-muted">
                            <template x-if="currentStep === 1">
                                <div>
                                    <p>契約の種類に応じて適切なテンプレートを選択してください。</p>
                                    <p>カスタムテンプレートでは独自の契約書を作成できます。</p>
                                </div>
                            </template>
                            <template x-if="currentStep === 2">
                                <div>
                                    <p>変数を使用することで、署名者情報や日付を自動挿入できます。</p>
                                    <p>署名欄は後で配置位置を調整できます。</p>
                                </div>
                            </template>
                            <template x-if="currentStep === 3">
                                <div>
                                    <p>署名順序を設定することで、段階的な承認フローを構築できます。</p>
                                    <p>認証方法はセキュリティレベルに応じて選択してください。</p>
                                </div>
                            </template>
                            <template x-if="currentStep === 4">
                                <div>
                                    <p>送信前に契約内容と署名者情報を必ず確認してください。</p>
                                    <p>CloudSign送信後は内容の変更ができません。</p>
                                </div>
                            </template>
                            <template x-if="currentStep === 5">
                                <div>
                                    <p>CloudSignとの接続を確認してから送信してください。</p>
                                    <p>送信後は進捗状況をダッシュボードで確認できます。</p>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- JavaScript -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('contractCreation', () => ({
                currentStep: 1,
                selectedTemplate: null,
                cloudSignConnected: true,
                sending: false,
                sendProgress: 0,
                sendCompleted: false,
                sendError: false,
                sendErrorMessage: '',
                cloudSignDocumentId: '',
                sendLogs: [],
                
                contractTemplates: [
                    {
                        id: 'EMPLOYMENT_AGREEMENT',
                        name: '準委任契約書',
                        description: '技術者派遣の準委任契約テンプレート',
                        category: '準委任',
                        icon: 'bi-briefcase',
                        estimatedTime: '15分'
                    },
                    {
                        id: 'SUBCONTRACT_AGREEMENT',
                        name: '請負契約書',
                        description: '成果物納品型の請負契約テンプレート',
                        category: '請負',
                        icon: 'bi-person-workspace',
                        estimatedTime: '20分'
                    },
                    {
                        id: 'CONSULTING_AGREEMENT',
                        name: 'コンサルティング契約書',
                        description: 'コンサルティングサービス提供のための契約',
                        category: 'コンサルティング',
                        icon: 'bi-shield-lock',
                        estimatedTime: '10分'
                    },
                    {
                        id: 'DISPATCH_AGREEMENT',
                        name: '派遣契約書',
                        description: '労働者派遣に関する契約テンプレート',
                        category: '派遣',
                        icon: 'bi-gear',
                        estimatedTime: '25分'
                    }
                ],
                
                contractVariables: [
                    { key: 'contractor_name', label: '受託者名' },
                    { key: 'client_name', label: '発注者名' },
                    { key: 'start_date', label: '契約開始日' },
                    { key: 'end_date', label: '契約終了日' },
                    { key: 'amount', label: '契約金額' },
                    { key: 'current_date', label: '現在日' },
                    { key: 'project_name', label: 'プロジェクト名' }
                ],
                
                engineers: [
                    { id: 'eng-001', name: '田中太郎' },
                    { id: 'eng-002', name: '佐藤花子' },
                    { id: 'eng-003', name: '鈴木一郎' }
                ],
                
                contractData: {
                    name: '',
                    type: 'SUBCONTRACT_AGREEMENT',
                    startDate: '',
                    endDate: '',
                    amount: '',
                    engineerId: '',
                    content: '',
                    signers: [
                        {
                            name: '',
                            email: '',
                            title: '',
                            order: 1,
                            authMethod: 'email',
                            deadline: 7,
                            message: ''
                        }
                    ]
                },
                
                cloudSignSettings: {
                    title: '',
                    expireDays: 30,
                    message: '',
                    autoReminder: true,
                    downloadProtection: false,
                    viewNotification: true
                },
                
                selectTemplate(template) {
                    this.selectedTemplate = template;
                    this.loadTemplateContent(template);
                },
                
                selectCustomTemplate() {
                    this.selectedTemplate = { id: 'custom', name: 'カスタム契約書' };
                    this.contractData.content = '';
                },
                
                loadTemplateContent(template) {
                    // テンプレート内容をロード
                    const templates = {
                        'SUBCONTRACT_AGREEMENT': `請負契約書

甲（{{client_name}}）と乙（{{contractor_name}}）は、以下のとおり業務委託契約を締結する。

第1条（業務内容）
乙は甲に対し、以下の業務を委託する。
・システム開発業務
・設計・実装・テスト業務
・運用サポート業務

第2条（委託期間）
本契約の期間は、{{start_date}}から{{end_date}}までとする。

第3条（委託料）
甲は乙に対し、{{amount}}円を支払うものとする。
支払いは月末締め翌月末払いとする。

第4条（秘密保持）
乙は業務上知り得た秘密情報を第三者に漏洩してはならない。

第5条（著作権）
本業務により生じた成果物の著作権は甲に帰属する。

第6条（契約の解除）
双方は30日前の書面通知により本契約を解除することができる。

以上、本契約の成立を証するため、本書2通を作成し、甲乙各1通を保有する。

{{current_date}}

甲：{{client_name}}
乙：{{contractor_name}}`
                    };
                    
                    this.contractData.content = templates[template.id] || '';
                },
                
                insertVariable(variable) {
                    this.contractData.content += `{{${variable.key}}}`;
                },
                
                addSignatureField(type) {
                    // 署名欄を契約書に追加
                    console.log('署名欄追加:', type);
                },
                
                addSigner() {
                    this.contractData.signers.push({
                        name: '',
                        email: '',
                        title: '',
                        order: this.contractData.signers.length + 1,
                        authMethod: 'email',
                        deadline: 7,
                        message: ''
                    });
                },
                
                removeSigner(index) {
                    this.contractData.signers.splice(index, 1);
                },
                
                nextStep() {
                    if (this.canProceed()) {
                        this.currentStep = Math.min(5, this.currentStep + 1);
                        if (this.currentStep === 5) {
                            this.cloudSignSettings.title = this.contractData.name;
                        }
                    }
                },
                
                previousStep() {
                    this.currentStep = Math.max(1, this.currentStep - 1);
                },
                
                canProceed() {
                    switch (this.currentStep) {
                        case 1:
                            return this.selectedTemplate !== null;
                        case 2:
                            return this.contractData.name && this.contractData.content;
                        case 3:
                            return this.contractData.signers.length > 0 && 
                                   this.contractData.signers.every(s => s.name && s.email);
                        case 4:
                            return true;
                        default:
                            return false;
                    }
                },
                
                getProgressPercentage() {
                    return (this.currentStep - 1) * 20 + (this.sendCompleted ? 20 : 0);
                },
                
                getPreviewContent() {
                    let content = this.contractData.content;
                    
                    // 変数を実際の値に置換
                    const replacements = {
                        'contractor_name': this.contractData.signers.find(s => s.title?.includes('受託'))?.name || '[受託者名]',
                        'client_name': this.contractData.signers.find(s => s.title?.includes('発注'))?.name || '[発注者名]',
                        'start_date': this.contractData.startDate || '[開始日]',
                        'end_date': this.contractData.endDate || '[終了日]',
                        'amount': this.contractData.amount ? this.formatCurrency(this.contractData.amount) : '[金額]',
                        'current_date': this.formatDate(new Date()),
                        'project_name': '[プロジェクト名]'
                    };
                    
                    Object.entries(replacements).forEach(([key, value]) => {
                        content = content.replace(new RegExp(`{{${key}}}`, 'g'), value);
                    });
                    
                    return content.replace(/\n/g, '<br>');
                },
                
                testCloudSignConnection() {
                    console.log('CloudSign接続テスト');
                    // 実際にはAPIを呼び出してテスト
                    this.cloudSignConnected = Math.random() > 0.2; // 80%の確率で成功
                },
                
                sendToCloudSign() {
                    this.sending = true;
                    this.sendProgress = 0;
                    this.sendLogs = [];
                    this.sendError = false;
                    this.sendCompleted = false;
                    
                    // 送信プロセスをシミュレート
                    this.addLog('info', 'CloudSignとの接続を開始中...');
                    
                    setTimeout(() => {
                        this.sendProgress = 20;
                        this.addLog('success', 'CloudSignとの接続が確立されました');
                        this.addLog('info', '契約書ファイルをアップロード中...');
                        
                        setTimeout(() => {
                            this.sendProgress = 50;
                            this.addLog('success', 'ファイルアップロードが完了しました');
                            this.addLog('info', '署名者情報を設定中...');
                            
                            setTimeout(() => {
                                this.sendProgress = 80;
                                this.addLog('success', '署名者設定が完了しました');
                                this.addLog('info', '署名依頼メールを送信中...');
                                
                                setTimeout(() => {
                                    this.sendProgress = 100;
                                    this.addLog('success', 'すべての処理が完了しました');
                                    this.cloudSignDocumentId = 'CS-' + Math.random().toString(36).substr(2, 9).toUpperCase();
                                    this.sending = false;
                                    this.sendCompleted = true;
                                }, 1000);
                            }, 1000);
                        }, 1000);
                    }, 1000);
                },
                
                addLog(type, message) {
                    this.sendLogs.push({
                        id: Date.now() + Math.random(),
                        type: type,
                        message: `${new Date().toLocaleTimeString()} - ${message}`
                    });
                },
                
                saveDraft() {
                    localStorage.setItem('contractDraft', JSON.stringify(this.contractData));
                    alert('下書きを保存しました。');
                },
                
                loadDraft() {
                    const draft = localStorage.getItem('contractDraft');
                    if (draft) {
                        this.contractData = JSON.parse(draft);
                    }
                },
                
                cancelCreation() {
                    if (confirm('作成中の契約書が失われますが、よろしいですか？')) {
                        window.location.href = '/contracts';
                    }
                },
                
                formatCurrency(amount) {
                    return new Intl.NumberFormat('ja-JP', {
                        style: 'currency',
                        currency: 'JPY'
                    }).format(amount);
                },
                
                formatDate(date) {
                    return date.toLocaleDateString('ja-JP', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                },
                
                init() {
                    this.loadDraft();
                }
            }));
        });
    </script>
</body>
</html>