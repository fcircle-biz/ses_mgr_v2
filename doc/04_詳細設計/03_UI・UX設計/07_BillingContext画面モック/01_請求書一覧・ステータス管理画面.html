<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>請求書一覧・ステータス管理 - SES業務システム</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    
    <!-- カスタムCSS -->
    <style>
        :root {
            --sidebar-width: 280px;
            --header-height: 60px;
            --ses-primary: #0d6efd;
            --ses-secondary: #6c757d;
            --ses-success: #198754;
            --ses-warning: #ffc107;
            --ses-danger: #dc3545;
            --ses-light: #f8f9fa;
        }
        
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: var(--header-height);
            min-height: calc(100vh - var(--header-height));
        }
        
        .sidebar {
            position: fixed;
            top: var(--header-height);
            left: 0;
            width: var(--sidebar-width);
            height: calc(100vh - var(--header-height));
            background-color: #212529;
            z-index: 1000;
        }
        
        .navbar {
            height: var(--header-height);
            background-color: #ffffff !important;
            border-bottom: 1px solid #dee2e6;
        }
        
        .billing-header {
            background: linear-gradient(135deg, var(--ses-success), #0d5e2a);
            color: white;
            padding: 2rem;
            border-radius: 0.375rem;
            margin-bottom: 2rem;
        }
        
        .stats-card {
            text-align: center;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            background: white;
            transition: all 0.2s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .invoice-card {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }
        
        .invoice-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .invoice-card.status-draft { border-left-color: var(--ses-secondary); }
        .invoice-card.status-issued { border-left-color: var(--ses-primary); }
        .invoice-card.status-sent { border-left-color: var(--ses-info); }
        .invoice-card.status-paid { border-left-color: var(--ses-success); }
        .invoice-card.status-overdue { border-left-color: var(--ses-danger); }
        .invoice-card.status-partially-paid { border-left-color: var(--ses-warning); }
        .invoice-card.status-cancelled { border-left-color: #343a40; }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
        }
        
        .amount-display {
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        .due-date-warning {
            position: relative;
        }
        
        .due-date-warning::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background: var(--ses-danger);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .moneyforward-status {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            border: 1px solid;
        }
        
        .moneyforward-synced {
            background: #e8f5e8;
            border-color: var(--ses-success);
            color: var(--ses-success);
        }
        
        .moneyforward-pending {
            background: #fff3e0;
            border-color: var(--ses-warning);
            color: var(--ses-warning);
        }
        
        .moneyforward-error {
            background: #ffebee;
            border-color: var(--ses-danger);
            color: var(--ses-danger);
        }
        
        .filter-section {
            background: var(--ses-light);
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        
        .payment-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .progress-bar-custom {
            flex: 1;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--ses-success);
            transition: width 0.3s ease;
        }
        
        .quick-actions {
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .invoice-card:hover .quick-actions {
            opacity: 1;
        }
        
        .bulk-actions {
            background: var(--ses-light);
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            display: none;
        }
        
        .bulk-actions.active {
            display: block;
        }
        
        .overdue-highlight {
            background: rgba(220, 53, 69, 0.1);
            border-color: var(--ses-danger);
        }
        
        .chart-container {
            height: 200px;
            margin-bottom: 1rem;
        }
        
        .currency-selector {
            min-width: 120px;
        }
        
        .invoice-timeline {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .timeline-step {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .timeline-step.completed {
            background: var(--ses-success);
            color: white;
        }
        
        .timeline-step.active {
            background: var(--ses-primary);
            color: white;
        }
        
        .customer-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .customer-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        
        .aging-indicator {
            font-size: 0.75rem;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }
        
        .aging-current { background: #e8f5e8; color: var(--ses-success); }
        .aging-30 { background: #fff3e0; color: var(--ses-warning); }
        .aging-60 { background: #ffebee; color: var(--ses-danger); }
        .aging-90 { background: #f3e5f5; color: #7b1fa2; }
    </style>
</head>
<body x-data="invoiceList" x-cloak>
    
    <!-- ヘッダー -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container-fluid">
            <button class="btn btn-outline-secondary me-3" @click="toggleSidebar()">
                <i class="bi bi-list"></i>
            </button>
            <a class="navbar-brand" href="#">SES業務システム</a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle me-1"></i>山田太郎
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>プロフィール</a></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>設定</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-box-arrow-right me-2"></i>ログアウト</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- サイドバー -->
    <nav class="sidebar text-white">
        <div class="p-3">
            <ul class="nav nav-pills flex-column">
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-briefcase me-2"></i>案件管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-people me-2"></i>技術者管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-search-heart me-2"></i>マッチング
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-file-earmark-text me-2"></i>契約管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-clock me-2"></i>勤怠管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white active" href="#">
                        <i class="bi bi-receipt me-2"></i>請求管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-graph-up me-2"></i>レポート
                    </a>
                </li>
            </ul>
        </div>
    </nav>
    
    <!-- メインコンテンツ -->
    <main class="main-content">
        <div class="container-fluid p-4">
            <!-- ページヘッダー -->
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h1 class="h3 mb-2">請求書一覧・ステータス管理</h1>
                    <p class="text-muted mb-0">請求書の発行・送付・入金管理・MoneyForward連携</p>
                </div>
                <div class="d-flex gap-2">
                    <select class="form-select currency-selector" x-model="selectedCurrency">
                        <option value="JPY">JPY (円)</option>
                        <option value="USD">USD (ドル)</option>
                        <option value="EUR">EUR (ユーロ)</option>
                    </select>
                    <button class="btn btn-outline-secondary" @click="exportInvoices()">
                        <i class="bi bi-download me-1"></i>エクスポート
                    </button>
                    <button class="btn btn-outline-info" @click="syncMoneyForward()">
                        <i class="bi bi-cloud me-1"></i>MoneyForward同期
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-plus me-1"></i>新規作成
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" @click="createInvoice('manual')">
                                <i class="bi bi-file-earmark-plus me-2"></i>手動作成
                            </a></li>
                            <li><a class="dropdown-item" href="#" @click="createInvoice('timesheet')">
                                <i class="bi bi-clock me-2"></i>工数表から作成
                            </a></li>
                            <li><a class="dropdown-item" href="#" @click="bulkCreateInvoices()">
                                <i class="bi bi-files me-2"></i>一括生成
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- 請求統計サマリー -->
            <div class="billing-header">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h4 class="mb-3">請求統計サマリー</h4>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="stats-number text-warning" x-text="formatCurrency(stats.pending)">¥5,200,000</div>
                                    <div class="small">未入金</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="stats-number text-danger" x-text="stats.overdue">3</div>
                                    <div class="small">期限超過</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="stats-number text-success" x-text="formatCurrency(stats.thisMonth)">¥12,800,000</div>
                                    <div class="small">今月請求</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="stats-number text-info" x-text="stats.avgDays">15.2</div>
                                    <div class="small">平均回収日数</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="chart-container">
                            <canvas id="monthlyTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- フィルター・検索エリア -->
            <div class="filter-section">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">請求書番号・顧客名</label>
                        <input type="text" class="form-control" placeholder="検索キーワード" x-model="filters.keyword">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ステータス</label>
                        <select class="form-select" x-model="filters.status">
                            <option value="">すべて</option>
                            <option value="DRAFT">下書き</option>
                            <option value="ISSUED">発行済み</option>
                            <option value="SENT">送付済み</option>
                            <option value="PAID">入金済み</option>
                            <option value="OVERDUE">期限超過</option>
                            <option value="PARTIALLY_PAID">一部入金</option>
                            <option value="CANCELLED">キャンセル</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">請求月</label>
                        <input type="month" class="form-control" x-model="filters.billingPeriod">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">支払期限</label>
                        <select class="form-select" x-model="filters.dueDate">
                            <option value="">指定なし</option>
                            <option value="overdue">期限切れ</option>
                            <option value="7days">7日以内</option>
                            <option value="30days">30日以内</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">MoneyForward</label>
                        <select class="form-select" x-model="filters.moneyForwardStatus">
                            <option value="">すべて</option>
                            <option value="synced">同期済み</option>
                            <option value="pending">同期待ち</option>
                            <option value="error">エラー</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" @click="searchInvoices()">
                                <i class="bi bi-search me-1"></i>検索
                            </button>
                            <button class="btn btn-outline-secondary" @click="resetFilters()">
                                <i class="bi bi-x-circle me-1"></i>リセット
                            </button>
                            <button class="btn btn-outline-info" @click="saveFilter()">
                                <i class="bi bi-bookmark me-1"></i>フィルタ保存
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 一括操作エリア -->
            <div class="bulk-actions" :class="{ active: selectedInvoices.length > 0 }">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong x-text="`${selectedInvoices.length}件選択中`"></strong>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm" @click="bulkSendInvoices()">
                            <i class="bi bi-send me-1"></i>一括送付
                        </button>
                        <button class="btn btn-outline-success btn-sm" @click="bulkSyncMoneyForward()">
                            <i class="bi bi-cloud me-1"></i>MF一括同期
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" @click="bulkExport()">
                            <i class="bi bi-download me-1"></i>一括エクスポート
                        </button>
                        <button class="btn btn-outline-danger btn-sm" @click="bulkDelete()">
                            <i class="bi bi-trash me-1"></i>一括削除
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 操作エリア -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center gap-3">
                    <span class="text-muted" x-text="`全${totalCount}件中 ${startIndex}-${endIndex}件を表示`"></span>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" x-model="selectAll" @change="toggleSelectAll()">
                        <label class="form-check-label">全選択</label>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-grid me-1"></i>表示
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" @click="viewMode = 'card'">
                                <i class="bi bi-grid-3x3-gap me-2"></i>カード表示
                            </a></li>
                            <li><a class="dropdown-item" href="#" @click="viewMode = 'table'">
                                <i class="bi bi-table me-2"></i>テーブル表示
                            </a></li>
                            <li><a class="dropdown-item" href="#" @click="viewMode = 'aging'">
                                <i class="bi bi-clock-history me-2"></i>エイジング表示
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- 請求書一覧 -->
            <div class="row">
                <template x-for="invoice in filteredInvoices" :key="invoice.id">
                    <div class="col-lg-6 col-xl-4 mb-4" x-show="viewMode === 'card'">
                        <div class="invoice-card" 
                             :class="[`status-${invoice.status.toLowerCase()}`, { 'overdue-highlight': invoice.isOverdue }]"
                             @click="viewInvoice(invoice.id)">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="form-check" @click.stop>
                                    <input class="form-check-input" type="checkbox" 
                                           :value="invoice.id" 
                                           x-model="selectedInvoices">
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="status-badge" :class="getStatusClass(invoice.status)" x-text="getStatusText(invoice.status)"></span>
                                    <div x-show="invoice.isOverdue" class="due-date-warning">
                                        <i class="bi bi-exclamation-triangle text-danger"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <h6 class="mb-1" x-text="invoice.invoiceNumber">INV-2025-001</h6>
                                <div class="customer-info mb-2">
                                    <img :src="invoice.customer.logo" class="customer-avatar">
                                    <div>
                                        <div class="fw-medium" x-text="invoice.customer.name"></div>
                                        <div class="small text-muted" x-text="invoice.projectName"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="amount-display text-primary" x-text="formatCurrency(invoice.totalAmount)">¥800,000</div>
                                <div class="small text-muted">
                                    請求期間: <span x-text="invoice.billingPeriod"></span>
                                </div>
                                <div class="small text-muted">
                                    支払期限: <span x-text="formatDate(invoice.dueDate)"></span>
                                </div>
                            </div>
                            
                            <!-- 支払進捗 -->
                            <div class="payment-progress" x-show="invoice.paidAmount > 0">
                                <div class="progress-bar-custom">
                                    <div class="progress-fill" 
                                         :style="`width: ${(invoice.paidAmount / invoice.totalAmount) * 100}%`"></div>
                                </div>
                                <span class="small text-muted" x-text="`${Math.round((invoice.paidAmount / invoice.totalAmount) * 100)}%`"></span>
                            </div>
                            
                            <!-- MoneyForward連携ステータス -->
                            <div class="mb-3">
                                <div class="moneyforward-status" :class="getMoneyForwardClass(invoice.moneyForwardStatus)">
                                    <i class="bi" :class="getMoneyForwardIcon(invoice.moneyForwardStatus)"></i>
                                    <span x-text="getMoneyForwardText(invoice.moneyForwardStatus)"></span>
                                </div>
                            </div>
                            
                            <!-- 請求進捗タイムライン -->
                            <div class="invoice-timeline">
                                <div class="timeline-step" :class="{ completed: invoice.progress >= 1, active: invoice.progress === 1 }">
                                    <i class="bi bi-file-earmark"></i>
                                    <small>作成</small>
                                </div>
                                <div class="timeline-step" :class="{ completed: invoice.progress >= 2, active: invoice.progress === 2 }">
                                    <i class="bi bi-send"></i>
                                    <small>送付</small>
                                </div>
                                <div class="timeline-step" :class="{ completed: invoice.progress >= 3, active: invoice.progress === 3 }">
                                    <i class="bi bi-currency-yen"></i>
                                    <small>入金</small>
                                </div>
                                <div class="timeline-step" :class="{ completed: invoice.progress >= 4, active: invoice.progress === 4 }">
                                    <i class="bi bi-check-circle"></i>
                                    <small>完了</small>
                                </div>
                            </div>
                            
                            <!-- クイックアクション -->
                            <div class="quick-actions">
                                <button class="btn btn-outline-primary btn-sm" @click.stop="viewInvoice(invoice.id)" title="詳細">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" @click.stop="editInvoice(invoice.id)" title="編集">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-success btn-sm" @click.stop="sendInvoice(invoice.id)" title="送付" x-show="invoice.status === 'DRAFT' || invoice.status === 'ISSUED'">
                                    <i class="bi bi-send"></i>
                                </button>
                                <button class="btn btn-outline-info btn-sm" @click.stop="recordPayment(invoice.id)" title="入金記録" x-show="invoice.status === 'SENT'">
                                    <i class="bi bi-currency-yen"></i>
                                </button>
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" @click.stop>
                                        <span class="visually-hidden">その他</span>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" @click="downloadPDF(invoice.id)">
                                            <i class="bi bi-download me-2"></i>PDF出力
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" @click="duplicateInvoice(invoice.id)">
                                            <i class="bi bi-files me-2"></i>複製
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" @click="syncToMoneyForward(invoice.id)" x-show="invoice.moneyForwardStatus !== 'synced'">
                                            <i class="bi bi-cloud me-2"></i>MF同期
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" @click="deleteInvoice(invoice.id)">
                                            <i class="bi bi-trash me-2"></i>削除
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <!-- テーブル表示 -->
            <div x-show="viewMode === 'table'" class="card">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="50">
                                    <input type="checkbox" class="form-check-input" x-model="selectAll" @change="toggleSelectAll()">
                                </th>
                                <th>請求書番号</th>
                                <th>顧客</th>
                                <th>請求金額</th>
                                <th>ステータス</th>
                                <th>支払期限</th>
                                <th>入金状況</th>
                                <th>MF連携</th>
                                <th width="120">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="invoice in filteredInvoices" :key="invoice.id">
                                <tr :class="{ 'table-danger': invoice.isOverdue }">
                                    <td>
                                        <input type="checkbox" class="form-check-input" 
                                               :value="invoice.id" 
                                               x-model="selectedInvoices">
                                    </td>
                                    <td>
                                        <a href="#" class="text-decoration-none fw-medium" x-text="invoice.invoiceNumber" @click="viewInvoice(invoice.id)"></a>
                                        <div class="small text-muted" x-text="invoice.projectName"></div>
                                    </td>
                                    <td>
                                        <div class="customer-info">
                                            <img :src="invoice.customer.logo" class="customer-avatar">
                                            <span x-text="invoice.customer.name"></span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="fw-medium" x-text="formatCurrency(invoice.totalAmount)"></span>
                                        <div class="small text-muted" x-text="invoice.billingPeriod"></div>
                                    </td>
                                    <td>
                                        <span class="status-badge" :class="getStatusClass(invoice.status)" x-text="getStatusText(invoice.status)"></span>
                                    </td>
                                    <td>
                                        <span x-text="formatDate(invoice.dueDate)"></span>
                                        <div x-show="invoice.isOverdue" class="small text-danger">
                                            <i class="bi bi-exclamation-triangle me-1"></i>期限超過
                                        </div>
                                    </td>
                                    <td>
                                        <div x-show="invoice.paidAmount > 0">
                                            <span x-text="formatCurrency(invoice.paidAmount)"></span>
                                            <div class="progress" style="height: 4px;">
                                                <div class="progress-bar bg-success" 
                                                     :style="`width: ${(invoice.paidAmount / invoice.totalAmount) * 100}%`"></div>
                                            </div>
                                        </div>
                                        <span x-show="invoice.paidAmount === 0" class="text-muted">未入金</span>
                                    </td>
                                    <td>
                                        <div class="moneyforward-status" :class="getMoneyForwardClass(invoice.moneyForwardStatus)">
                                            <i class="bi" :class="getMoneyForwardIcon(invoice.moneyForwardStatus)"></i>
                                            <span x-text="getMoneyForwardText(invoice.moneyForwardStatus)"></span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" @click="viewInvoice(invoice.id)" title="詳細">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary" @click="editInvoice(invoice.id)" title="編集">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <div class="dropdown">
                                                <button class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">
                                                    <span class="visually-hidden">その他</span>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-end">
                                                    <li><a class="dropdown-item" href="#" @click="sendInvoice(invoice.id)">
                                                        <i class="bi bi-send me-2"></i>送付
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="#" @click="recordPayment(invoice.id)">
                                                        <i class="bi bi-currency-yen me-2"></i>入金記録
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="#" @click="downloadPDF(invoice.id)">
                                                        <i class="bi bi-download me-2"></i>PDF出力
                                                    </a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- エイジング表示 -->
            <div x-show="viewMode === 'aging'" class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history me-2"></i>債権エイジング分析
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <template x-for="aging in agingAnalysis" :key="aging.range">
                            <div class="col-md-3 mb-3">
                                <div class="card">
                                    <div class="card-header" :class="`bg-${aging.color}`">
                                        <h6 class="card-title mb-0 text-white" x-text="aging.range"></h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="h4 mb-1" x-text="formatCurrency(aging.amount)"></div>
                                        <div class="small text-muted" x-text="`${aging.count}件`"></div>
                                        <div class="mt-2">
                                            <template x-for="invoice in aging.invoices" :key="invoice.id">
                                                <div class="small mb-1">
                                                    <a href="#" @click="viewInvoice(invoice.id)" x-text="invoice.invoiceNumber"></a>
                                                    <span x-text="formatCurrency(invoice.totalAmount)"></span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            
            <!-- ページネーション -->
            <nav class="mt-4" aria-label="ページネーション">
                <ul class="pagination justify-content-center">
                    <li class="page-item" :class="{ disabled: currentPage === 1 }">
                        <button class="page-link" @click="goToPage(currentPage - 1)">前へ</button>
                    </li>
                    <template x-for="page in visiblePages" :key="page">
                        <li class="page-item" :class="{ active: page === currentPage }">
                            <button class="page-link" @click="goToPage(page)" x-text="page"></button>
                        </li>
                    </template>
                    <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                        <button class="page-link" @click="goToPage(currentPage + 1)">次へ</button>
                    </li>
                </ul>
            </nav>
        </div>
    </main>
    
    <!-- JavaScript -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('invoiceList', () => ({
                selectedCurrency: 'JPY',
                selectedInvoices: [],
                selectAll: false,
                viewMode: 'card',
                currentPage: 1,
                pageSize: 12,
                totalCount: 25,
                
                filters: {
                    keyword: '',
                    status: '',
                    billingPeriod: '',
                    dueDate: '',
                    moneyForwardStatus: ''
                },
                
                stats: {
                    pending: 5200000,
                    overdue: 3,
                    thisMonth: 12800000,
                    avgDays: 15.2
                },
                
                invoices: [
                    {
                        id: '550e8400-e29b-41d4-a716-446655440100',
                        invoiceNumber: 'INV-2025-001',
                        customerId: '660f9511-f39c-52e5-b827-557766551111',
                        customer: { 
                            id: '660f9511-f39c-52e5-b827-557766551111',
                            name: '株式会社ABC商事', 
                            logo: 'https://via.placeholder.com/32' 
                        },
                        projectId: '123e4567-e89b-12d3-a456-426614174000',
                        projectName: 'ECサイトリニューアル',
                        totalAmount: {
                            amount: 800000,
                            currency: 'JPY'
                        },
                        paidAmount: {
                            amount: 0,
                            currency: 'JPY'
                        },
                        status: 'SENT',
                        issueDate: '2025-05-31',
                        dueDate: '2025-06-15',
                        billingPeriod: {
                            year: 2025,
                            month: 5
                        },
                        isOverdue: false,
                        progress: 2,
                        moneyForwardStatus: 'synced'
                    },
                    {
                        id: '770a0622-a4ad-63f6-c938-668877662000',
                        invoiceNumber: 'INV-2025-002',
                        customerId: '880b1733-b5be-74g7-d049-779988773000',
                        customer: { 
                            id: '880b1733-b5be-74g7-d049-779988773000',
                            name: 'XYZ製造株式会社', 
                            logo: 'https://via.placeholder.com/32' 
                        },
                        projectId: '456e7890-e89b-12d3-a456-426614174001',
                        projectName: '基幹システム更改',
                        totalAmount: {
                            amount: 1200000,
                            currency: 'JPY'
                        },
                        paidAmount: {
                            amount: 600000,
                            currency: 'JPY'
                        },
                        status: 'PARTIALLY_PAID',
                        issueDate: '2025-04-30',
                        dueDate: '2025-05-20',
                        billingPeriod: {
                            year: 2025,
                            month: 4
                        },
                        isOverdue: true,
                        progress: 3,
                        moneyForwardStatus: 'pending'
                    },
                    {
                        id: '990c2844-c6cf-85h8-e15a-88aa99884000',
                        invoiceNumber: 'INV-2025-003',
                        customerId: 'aa0d3955-d7da-96i9-f26b-99bb00995555',
                        customer: { 
                            id: 'aa0d3955-d7da-96i9-f26b-99bb00995555',
                            name: 'テクノロジー株式会社', 
                            logo: 'https://via.placeholder.com/32' 
                        },
                        projectId: '789e0123-e89b-12d3-a456-426614174002',
                        projectName: 'モバイルアプリ開発',
                        totalAmount: {
                            amount: 950000,
                            currency: 'JPY'
                        },
                        paidAmount: {
                            amount: 950000,
                            currency: 'JPY'
                        },
                        status: 'PAID',
                        issueDate: '2025-05-31',
                        dueDate: '2025-06-30',
                        billingPeriod: {
                            year: 2025,
                            month: 5
                        },
                        isOverdue: false,
                        progress: 4,
                        moneyForwardStatus: 'synced'
                    }
                ],
                
                agingAnalysis: [
                    {
                        range: '0-30日',
                        receivableStatus: 'CURRENT',
                        amount: {
                            amount: 2100000,
                            currency: 'JPY'
                        },
                        count: 3,
                        color: 'success',
                        invoices: [
                            { 
                                id: '550e8400-e29b-41d4-a716-446655440100', 
                                invoiceNumber: 'INV-2025-001', 
                                totalAmount: {
                                    amount: 800000,
                                    currency: 'JPY'
                                }
                            }
                        ]
                    },
                    {
                        range: '31-60日',
                        receivableStatus: 'OVERDUE_31_60',
                        amount: {
                            amount: 1500000,
                            currency: 'JPY'
                        },
                        count: 2,
                        color: 'warning',
                        invoices: [
                            { 
                                id: '770a0622-a4ad-63f6-c938-668877662000', 
                                invoiceNumber: 'INV-2025-002', 
                                totalAmount: {
                                    amount: 1200000,
                                    currency: 'JPY'
                                }
                            }
                        ]
                    },
                    {
                        range: '61-90日',
                        receivableStatus: 'OVERDUE_61_90',
                        amount: {
                            amount: 800000,
                            currency: 'JPY'
                        },
                        count: 1,
                        color: 'danger',
                        invoices: []
                    },
                    {
                        range: '90日超',
                        receivableStatus: 'OVERDUE_OVER_90',
                        amount: {
                            amount: 300000,
                            currency: 'JPY'
                        },
                        count: 1,
                        color: 'dark',
                        invoices: []
                    }
                ],
                
                get filteredInvoices() {
                    return this.invoices.filter(invoice => {
                        if (this.filters.keyword && !invoice.invoiceNumber.toLowerCase().includes(this.filters.keyword.toLowerCase()) && 
                            !invoice.customer.name.toLowerCase().includes(this.filters.keyword.toLowerCase())) {
                            return false;
                        }
                        if (this.filters.status && invoice.status !== this.filters.status) {
                            return false;
                        }
                        if (this.filters.moneyForwardStatus && invoice.moneyForwardStatus !== this.filters.moneyForwardStatus) {
                            return false;
                        }
                        return true;
                    });
                },
                
                get totalPages() {
                    return Math.ceil(this.totalCount / this.pageSize);
                },
                
                get startIndex() {
                    return (this.currentPage - 1) * this.pageSize + 1;
                },
                
                get endIndex() {
                    return Math.min(this.currentPage * this.pageSize, this.totalCount);
                },
                
                get visiblePages() {
                    const pages = [];
                    const start = Math.max(1, this.currentPage - 2);
                    const end = Math.min(this.totalPages, this.currentPage + 2);
                    for (let i = start; i <= end; i++) {
                        pages.push(i);
                    }
                    return pages;
                },
                
                init() {
                    this.initCharts();
                },
                
                initCharts() {
                    const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                            datasets: [{
                                label: '請求金額',
                                data: [8500000, 9200000, 7800000, 10500000, 12800000, 11200000],
                                borderColor: 'white',
                                backgroundColor: 'rgba(255,255,255,0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { ticks: { color: 'white' } },
                                y: { ticks: { color: 'white' } }
                            }
                        }
                    });
                },
                
                toggleSelectAll() {
                    if (this.selectAll) {
                        this.selectedInvoices = this.filteredInvoices.map(i => i.id);
                    } else {
                        this.selectedInvoices = [];
                    }
                },
                
                getStatusClass(status) {
                    const classes = {
                        'DRAFT': 'bg-secondary',
                        'ISSUED': 'bg-primary',
                        'SENT': 'bg-info',
                        'PAID': 'bg-success',
                        'OVERDUE': 'bg-danger',
                        'PARTIALLY_PAID': 'bg-warning',
                        'CANCELLED': 'bg-dark'
                    };
                    return classes[status] || 'bg-secondary';
                },
                
                getStatusText(status) {
                    const texts = {
                        'DRAFT': '下書き',
                        'ISSUED': '発行済み',
                        'SENT': '送付済み',
                        'PAID': '入金済み',
                        'OVERDUE': '期限超過',
                        'PARTIALLY_PAID': '一部入金',
                        'CANCELLED': 'キャンセル'
                    };
                    return texts[status] || status;
                },
                
                getMoneyForwardClass(status) {
                    const classes = {
                        'synced': 'moneyforward-synced',
                        'pending': 'moneyforward-pending',
                        'error': 'moneyforward-error'
                    };
                    return classes[status] || 'moneyforward-pending';
                },
                
                getMoneyForwardIcon(status) {
                    const icons = {
                        'synced': 'bi-cloud-check',
                        'pending': 'bi-cloud-upload',
                        'error': 'bi-cloud-slash'
                    };
                    return icons[status] || 'bi-cloud';
                },
                
                getMoneyForwardText(status) {
                    const texts = {
                        'synced': 'MF同期済み',
                        'pending': 'MF同期待ち',
                        'error': 'MFエラー'
                    };
                    return texts[status] || '未同期';
                },
                
                formatCurrency(amount) {
                    return new Intl.NumberFormat('ja-JP', {
                        style: 'currency',
                        currency: this.selectedCurrency
                    }).format(amount);
                },
                
                formatDate(dateStr) {
                    return new Date(dateStr).toLocaleDateString('ja-JP');
                },
                
                goToPage(page) {
                    if (page >= 1 && page <= this.totalPages) {
                        this.currentPage = page;
                    }
                },
                
                searchInvoices() {
                    console.log('請求書検索実行', this.filters);
                },
                
                resetFilters() {
                    this.filters = { keyword: '', status: '', billingPeriod: '', dueDate: '', moneyForwardStatus: '' };
                },
                
                saveFilter() {
                    console.log('フィルタ保存');
                },
                
                exportInvoices() {
                    console.log('請求書エクスポート');
                },
                
                syncMoneyForward() {
                    console.log('MoneyForward同期');
                },
                
                createInvoice(type) {
                    console.log('請求書作成', type);
                },
                
                bulkCreateInvoices() {
                    console.log('請求書一括生成');
                },
                
                viewInvoice(id) {
                    console.log('請求書詳細表示', id);
                },
                
                editInvoice(id) {
                    console.log('請求書編集', id);
                },
                
                sendInvoice(id) {
                    console.log('請求書送付', id);
                },
                
                recordPayment(id) {
                    console.log('入金記録', id);
                },
                
                downloadPDF(id) {
                    console.log('PDF出力', id);
                },
                
                duplicateInvoice(id) {
                    console.log('請求書複製', id);
                },
                
                syncToMoneyForward(id) {
                    console.log('MoneyForward同期', id);
                },
                
                deleteInvoice(id) {
                    if (confirm('この請求書を削除しますか？')) {
                        console.log('請求書削除', id);
                    }
                },
                
                bulkSendInvoices() {
                    console.log('一括送付', this.selectedInvoices);
                },
                
                bulkSyncMoneyForward() {
                    console.log('MF一括同期', this.selectedInvoices);
                },
                
                bulkExport() {
                    console.log('一括エクスポート', this.selectedInvoices);
                },
                
                bulkDelete() {
                    if (confirm(`${this.selectedInvoices.length}件の請求書を削除しますか？`)) {
                        console.log('一括削除', this.selectedInvoices);
                    }
                }
            }));
        });
    </script>
</body>
</html>