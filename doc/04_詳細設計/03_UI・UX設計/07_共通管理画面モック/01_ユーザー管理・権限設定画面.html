<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ユーザー管理・権限設定 - SES業務システム</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    
    <!-- カスタムCSS -->
    <style>
        :root {
            --sidebar-width: 280px;
            --header-height: 60px;
            --ses-primary: #0d6efd;
            --ses-secondary: #6c757d;
            --ses-success: #198754;
            --ses-warning: #ffc107;
            --ses-danger: #dc3545;
            --ses-light: #f8f9fa;
        }
        
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: var(--header-height);
            min-height: calc(100vh - var(--header-height));
        }
        
        .sidebar {
            position: fixed;
            top: var(--header-height);
            left: 0;
            width: var(--sidebar-width);
            height: calc(100vh - var(--header-height));
            background-color: #212529;
            z-index: 1000;
        }
        
        .navbar {
            height: var(--header-height);
            background-color: #ffffff !important;
            border-bottom: 1px solid #dee2e6;
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        .role-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
            margin: 0.1rem;
        }
        
        .permission-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .permission-card {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
        }
        
        .nav-tabs .nav-link.active {
            border-color: var(--ses-primary);
            color: var(--ses-primary);
        }
    </style>
</head>
<body x-data="userManagement" x-cloak>
    
    <!-- ヘッダー -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container-fluid">
            <button class="btn btn-outline-secondary me-3" @click="toggleSidebar()">
                <i class="bi bi-list"></i>
            </button>
            <a class="navbar-brand" href="#">SES業務システム</a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle me-1"></i>システム管理者
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>プロフィール</a></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>設定</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-box-arrow-right me-2"></i>ログアウト</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- サイドバー -->
    <div class="sidebar" x-show="sidebarVisible" x-transition>
        <div class="p-3">
            <h6 class="text-light mb-3">管理機能</h6>
            <ul class="nav nav-pills flex-column">
                <li class="nav-item">
                    <a class="nav-link active text-light" href="#" @click="setActiveTab('users')">
                        <i class="bi bi-people me-2"></i>ユーザー管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-light" href="#" @click="setActiveTab('roles')">
                        <i class="bi bi-shield-check me-2"></i>ロール・権限管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-light" href="#" @click="setActiveTab('settings')">
                        <i class="bi bi-gear me-2"></i>システム設定
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-light" href="#" @click="setActiveTab('audit')">
                        <i class="bi bi-file-text me-2"></i>監査ログ
                    </a>
                </li>
            </ul>
        </div>
    </div>
    
    <!-- メインコンテンツ -->
    <main class="main-content">
        <div class="container-fluid p-4">
            
            <!-- ページヘッダー -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-1">ユーザー管理・権限設定</h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a href="#">管理画面</a></li>
                            <li class="breadcrumb-item active">ユーザー管理</li>
                        </ol>
                    </nav>
                </div>
                <div>
                    <button class="btn btn-primary" @click="openAddUserModal()">
                        <i class="bi bi-plus-circle me-1"></i>新規ユーザー追加
                    </button>
                </div>
            </div>
            
            <!-- タブナビゲーション -->
            <ul class="nav nav-tabs mb-4" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link" :class="{'active': activeTab === 'users'}" 
                            @click="setActiveTab('users')" type="button">
                        <i class="bi bi-people me-1"></i>ユーザー一覧
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" :class="{'active': activeTab === 'roles'}" 
                            @click="setActiveTab('roles')" type="button">
                        <i class="bi bi-shield-check me-1"></i>ロール管理
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" :class="{'active': activeTab === 'permissions'}" 
                            @click="setActiveTab('permissions')" type="button">
                        <i class="bi bi-key me-1"></i>権限設定
                    </button>
                </li>
            </ul>
            
            <!-- ユーザー一覧タブ -->
            <div x-show="activeTab === 'users'" class="tab-content">
                <!-- 検索・フィルターエリア -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">ユーザー名・メールアドレス検索</label>
                                <input type="text" class="form-control" x-model="userFilter.keyword" placeholder="検索キーワード">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">ステータス</label>
                                <select class="form-select" x-model="userFilter.status">
                                    <option value="">すべて</option>
                                    <option value="active">アクティブ</option>
                                    <option value="inactive">無効</option>
                                    <option value="locked">ロック中</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">ロール</label>
                                <select class="form-select" x-model="userFilter.role">
                                    <option value="">すべて</option>
                                    <option value="admin">システム管理者</option>
                                    <option value="manager">マネージャー</option>
                                    <option value="operator">オペレーター</option>
                                    <option value="viewer">閲覧者</option>
                                </select>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button class="btn btn-outline-primary w-100" @click="searchUsers()">
                                    <i class="bi bi-search me-1"></i>検索
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ユーザーリスト -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ユーザー一覧</h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-secondary" @click="bulkAction('activate')" 
                                    :disabled="selectedUsers.length === 0">
                                <i class="bi bi-check-circle me-1"></i>一括有効化
                            </button>
                            <button class="btn btn-sm btn-outline-warning" @click="bulkAction('deactivate')" 
                                    :disabled="selectedUsers.length === 0">
                                <i class="bi bi-x-circle me-1"></i>一括無効化
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th width="40">
                                            <input type="checkbox" class="form-check-input" @change="toggleSelectAll($event)">
                                        </th>
                                        <th>ユーザー名</th>
                                        <th>メールアドレス</th>
                                        <th>ロール</th>
                                        <th>ステータス</th>
                                        <th>最終ログイン</th>
                                        <th>作成日</th>
                                        <th width="120">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="user in filteredUsers" :key="user.id">
                                        <tr>
                                            <td>
                                                <input type="checkbox" class="form-check-input" 
                                                       :value="user.id" x-model="selectedUsers">
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="me-2">
                                                        <i class="bi bi-person-circle fs-4 text-muted"></i>
                                                    </div>
                                                    <div>
                                                        <div class="fw-medium" x-text="user.fullName"></div>
                                                        <small class="text-muted" x-text="user.username"></small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td x-text="user.email"></td>
                                            <td>
                                                <template x-for="role in user.roles">
                                                    <span class="badge role-badge" 
                                                          :class="{
                                                              'bg-danger': role.type === 'admin',
                                                              'bg-warning': role.type === 'manager',
                                                              'bg-info': role.type === 'operator',
                                                              'bg-secondary': role.type === 'viewer'
                                                          }"
                                                          x-text="role.name"></span>
                                                </template>
                                            </td>
                                            <td>
                                                <span class="badge status-badge" 
                                                      :class="{
                                                          'bg-success': user.status === 'active',
                                                          'bg-secondary': user.status === 'inactive',
                                                          'bg-warning': user.status === 'locked'
                                                      }"
                                                      x-text="getStatusText(user.status)"></span>
                                            </td>
                                            <td x-text="formatDate(user.lastLoginAt)"></td>
                                            <td x-text="formatDate(user.createdAt)"></td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <button class="btn btn-sm btn-outline-primary" 
                                                            @click="editUser(user)">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" 
                                                            @click="deleteUser(user)">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- ページネーション -->
                    <div class="card-footer">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-muted">
                                <span x-text="`${pagination.start} - ${pagination.end} / ${pagination.total}`"></span>件を表示
                            </div>
                            <nav>
                                <ul class="pagination mb-0">
                                    <li class="page-item" :class="{'disabled': pagination.currentPage === 1}">
                                        <a class="page-link" href="#" @click.prevent="changePage(pagination.currentPage - 1)">前へ</a>
                                    </li>
                                    <template x-for="page in pagination.pages" :key="page">
                                        <li class="page-item" :class="{'active': page === pagination.currentPage}">
                                            <a class="page-link" href="#" @click.prevent="changePage(page)" x-text="page"></a>
                                        </li>
                                    </template>
                                    <li class="page-item" :class="{'disabled': pagination.currentPage === pagination.totalPages}">
                                        <a class="page-link" href="#" @click.prevent="changePage(pagination.currentPage + 1)">次へ</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ロール管理タブ -->
            <div x-show="activeTab === 'roles'" class="tab-content">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">ロール一覧</h5>
                                <button class="btn btn-sm btn-primary" @click="openAddRoleModal()">
                                    <i class="bi bi-plus me-1"></i>新規ロール追加
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="list-group">
                                    <template x-for="role in roles" :key="role.id">
                                        <div class="list-group-item d-flex justify-content-between align-items-center"
                                             :class="{'active': selectedRole?.id === role.id}"
                                             @click="selectRole(role)">
                                            <div>
                                                <h6 class="mb-1" x-text="role.name"></h6>
                                                <p class="mb-1 text-muted small" x-text="role.description"></p>
                                                <small>ユーザー数: <span x-text="role.userCount"></span></small>
                                            </div>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline-primary" @click="editRole(role)">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" 
                                                        @click="deleteRole(role)" 
                                                        :disabled="role.userCount > 0">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card" x-show="selectedRole">
                            <div class="card-header">
                                <h5 class="mb-0">ロール詳細: <span x-text="selectedRole?.name"></span></h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <strong>説明:</strong>
                                    <p x-text="selectedRole?.description"></p>
                                </div>
                                <div class="mb-3">
                                    <strong>権限:</strong>
                                    <div class="mt-2">
                                        <template x-for="permission in selectedRole?.permissions || []">
                                            <span class="badge bg-primary me-1 mb-1" x-text="permission.name"></span>
                                        </template>
                                    </div>
                                </div>
                                <div>
                                    <strong>割り当てユーザー:</strong>
                                    <div class="mt-2">
                                        <template x-for="user in selectedRole?.users || []">
                                            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                                                <span x-text="user.fullName"></span>
                                                <button class="btn btn-sm btn-outline-danger" 
                                                        @click="removeUserFromRole(user.id, selectedRole.id)">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 権限設定タブ -->
            <div x-show="activeTab === 'permissions'" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">権限マトリックス</h5>
                    </div>
                    <div class="card-body">
                        <div class="permission-grid">
                            <template x-for="context in permissionContexts" :key="context.name">
                                <div class="permission-card">
                                    <h6 class="fw-bold mb-3" x-text="context.displayName"></h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>権限</th>
                                                    <th class="text-center">管理者</th>
                                                    <th class="text-center">マネージャー</th>
                                                    <th class="text-center">オペレーター</th>
                                                    <th class="text-center">閲覧者</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="permission in context.permissions" :key="permission.name">
                                                    <tr>
                                                        <td x-text="permission.displayName"></td>
                                                        <td class="text-center">
                                                            <input type="checkbox" class="form-check-input" 
                                                                   :checked="hasPermission('admin', context.name, permission.name)"
                                                                   @change="togglePermission('admin', context.name, permission.name, $event.target.checked)">
                                                        </td>
                                                        <td class="text-center">
                                                            <input type="checkbox" class="form-check-input" 
                                                                   :checked="hasPermission('manager', context.name, permission.name)"
                                                                   @change="togglePermission('manager', context.name, permission.name, $event.target.checked)">
                                                        </td>
                                                        <td class="text-center">
                                                            <input type="checkbox" class="form-check-input" 
                                                                   :checked="hasPermission('operator', context.name, permission.name)"
                                                                   @change="togglePermission('operator', context.name, permission.name, $event.target.checked)">
                                                        </td>
                                                        <td class="text-center">
                                                            <input type="checkbox" class="form-check-input" 
                                                                   :checked="hasPermission('viewer', context.name, permission.name)"
                                                                   @change="togglePermission('viewer', context.name, permission.name, $event.target.checked)">
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <div class="mt-4 text-end">
                            <button class="btn btn-primary" @click="savePermissions()">
                                <i class="bi bi-check-circle me-1"></i>権限設定を保存
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- ユーザー追加/編集モーダル -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" x-text="editingUser.id ? 'ユーザー編集' : '新規ユーザー追加'"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ユーザー名 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" x-model="editingUser.username" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">フルネーム <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" x-model="editingUser.fullName" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">メールアドレス <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" x-model="editingUser.email" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">電話番号</label>
                                    <input type="tel" class="form-control" x-model="editingUser.phone">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ロール <span class="text-danger">*</span></label>
                                    <select class="form-select" x-model="editingUser.roleIds" multiple>
                                        <template x-for="role in roles" :key="role.id">
                                            <option :value="role.id" x-text="role.name"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ステータス</label>
                                    <select class="form-select" x-model="editingUser.status">
                                        <option value="active">アクティブ</option>
                                        <option value="inactive">無効</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div x-show="!editingUser.id">
                            <div class="mb-3">
                                <label class="form-label">初期パスワード <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" x-model="editingUser.password">
                                <div class="form-text">8文字以上、英数字・記号を含む</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" @click="saveUser()">
                        <i class="bi bi-check-circle me-1"></i>保存
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('userManagement', () => ({
                // 状態管理
                activeTab: 'users',
                sidebarVisible: true,
                
                // フィルター
                userFilter: {
                    keyword: '',
                    status: '',
                    role: ''
                },
                
                // 選択状態
                selectedUsers: [],
                selectedRole: null,
                
                // 編集中のユーザー
                editingUser: {},
                
                // ページネーション
                pagination: {
                    currentPage: 1,
                    totalPages: 5,
                    total: 95,
                    start: 1,
                    end: 20,
                    pages: [1, 2, 3, 4, 5]
                },
                
                // サンプルデータ
                users: [
                    {
                        id: 1,
                        username: 'admin',
                        fullName: 'システム管理者',
                        email: 'admin@ses-mgr.com',
                        phone: '03-1234-5678',
                        status: 'active',
                        roles: [{type: 'admin', name: 'システム管理者'}],
                        lastLoginAt: '2025-06-01T09:30:00',
                        createdAt: '2024-01-01T00:00:00'
                    },
                    {
                        id: 2,
                        username: 'manager01',
                        fullName: '田中マネージャー',
                        email: 'tanaka@ses-mgr.com',
                        phone: '03-1234-5679',
                        status: 'active',
                        roles: [{type: 'manager', name: 'マネージャー'}],
                        lastLoginAt: '2025-06-01T08:15:00',
                        createdAt: '2024-02-15T00:00:00'
                    },
                    {
                        id: 3,
                        username: 'operator01',
                        fullName: '佐藤オペレーター',
                        email: 'sato@ses-mgr.com',
                        phone: '03-1234-5680',
                        status: 'active',
                        roles: [{type: 'operator', name: 'オペレーター'}],
                        lastLoginAt: '2025-05-30T17:45:00',
                        createdAt: '2024-03-10T00:00:00'
                    }
                ],
                
                roles: [
                    {
                        id: 1,
                        name: 'システム管理者',
                        description: 'システム全体の管理権限',
                        userCount: 1,
                        permissions: [
                            {name: 'admin.all', displayName: '全権限'}
                        ],
                        users: [{id: 1, fullName: 'システム管理者'}]
                    },
                    {
                        id: 2,
                        name: 'マネージャー',
                        description: 'プロジェクト・チーム管理権限',
                        userCount: 5,
                        permissions: [
                            {name: 'project.manage', displayName: 'プロジェクト管理'},
                            {name: 'engineer.manage', displayName: '技術者管理'}
                        ],
                        users: [{id: 2, fullName: '田中マネージャー'}]
                    }
                ],
                
                permissionContexts: [
                    {
                        name: 'project',
                        displayName: 'プロジェクト管理',
                        permissions: [
                            {name: 'read', displayName: '閲覧'},
                            {name: 'create', displayName: '作成'},
                            {name: 'update', displayName: '更新'},
                            {name: 'delete', displayName: '削除'}
                        ]
                    },
                    {
                        name: 'engineer',
                        displayName: '技術者管理',
                        permissions: [
                            {name: 'read', displayName: '閲覧'},
                            {name: 'create', displayName: '作成'},
                            {name: 'update', displayName: '更新'},
                            {name: 'delete', displayName: '削除'}
                        ]
                    }
                ],
                
                // 計算プロパティ
                get filteredUsers() {
                    return this.users.filter(user => {
                        const matchesKeyword = !this.userFilter.keyword || 
                            user.fullName.includes(this.userFilter.keyword) ||
                            user.email.includes(this.userFilter.keyword);
                        const matchesStatus = !this.userFilter.status || user.status === this.userFilter.status;
                        const matchesRole = !this.userFilter.role || 
                            user.roles.some(role => role.type === this.userFilter.role);
                        return matchesKeyword && matchesStatus && matchesRole;
                    });
                },
                
                // メソッド
                toggleSidebar() {
                    this.sidebarVisible = !this.sidebarVisible;
                },
                
                setActiveTab(tab) {
                    this.activeTab = tab;
                },
                
                searchUsers() {
                    // API呼び出し実装
                    console.log('Searching users with filters:', this.userFilter);
                },
                
                getStatusText(status) {
                    const statusMap = {
                        'active': 'アクティブ',
                        'inactive': '無効',
                        'locked': 'ロック中'
                    };
                    return statusMap[status] || status;
                },
                
                formatDate(dateString) {
                    if (!dateString) return '-';
                    return new Date(dateString).toLocaleDateString('ja-JP');
                },
                
                toggleSelectAll(event) {
                    if (event.target.checked) {
                        this.selectedUsers = this.filteredUsers.map(user => user.id);
                    } else {
                        this.selectedUsers = [];
                    }
                },
                
                openAddUserModal() {
                    this.editingUser = {
                        username: '',
                        fullName: '',
                        email: '',
                        phone: '',
                        roleIds: [],
                        status: 'active',
                        password: ''
                    };
                    new bootstrap.Modal(document.getElementById('userModal')).show();
                },
                
                editUser(user) {
                    this.editingUser = { ...user, roleIds: user.roles.map(r => r.id) };
                    new bootstrap.Modal(document.getElementById('userModal')).show();
                },
                
                saveUser() {
                    // API呼び出し実装
                    console.log('Saving user:', this.editingUser);
                    bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                },
                
                deleteUser(user) {
                    if (confirm(`ユーザー「${user.fullName}」を削除してもよろしいですか？`)) {
                        // API呼び出し実装
                        console.log('Deleting user:', user.id);
                    }
                },
                
                bulkAction(action) {
                    if (confirm(`選択したユーザーを${action === 'activate' ? '有効化' : '無効化'}してもよろしいですか？`)) {
                        // API呼び出し実装
                        console.log(`Bulk ${action} for users:`, this.selectedUsers);
                    }
                },
                
                selectRole(role) {
                    this.selectedRole = role;
                },
                
                hasPermission(roleType, context, permission) {
                    // 権限チェックロジック実装
                    return roleType === 'admin' || (roleType === 'manager' && permission !== 'delete');
                },
                
                togglePermission(roleType, context, permission, granted) {
                    // 権限変更ロジック実装
                    console.log(`Toggle permission: ${roleType}.${context}.${permission} = ${granted}`);
                },
                
                savePermissions() {
                    // API呼び出し実装
                    console.log('Saving permissions');
                },
                
                changePage(page) {
                    if (page >= 1 && page <= this.pagination.totalPages) {
                        this.pagination.currentPage = page;
                        // API呼び出し実装
                    }
                }
            }));
        });
    </script>
</body>
</html>