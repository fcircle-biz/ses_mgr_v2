<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マッチング検索・条件設定 - SES業務システム</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    
    <!-- カスタムCSS -->
    <style>
        :root {
            --sidebar-width: 280px;
            --header-height: 60px;
            --ses-primary: #0d6efd;
            --ses-secondary: #6c757d;
            --ses-success: #198754;
            --ses-warning: #ffc107;
            --ses-danger: #dc3545;
            --ses-light: #f8f9fa;
        }
        
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: var(--header-height);
            min-height: calc(100vh - var(--header-height));
        }
        
        .sidebar {
            position: fixed;
            top: var(--header-height);
            left: 0;
            width: var(--sidebar-width);
            height: calc(100vh - var(--header-height));
            background-color: #212529;
            z-index: 1000;
        }
        
        .navbar {
            height: var(--header-height);
            background-color: #ffffff !important;
            border-bottom: 1px solid #dee2e6;
        }
        
        .project-card {
            border: 2px solid #dee2e6;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .project-card:hover {
            border-color: var(--ses-primary);
            box-shadow: 0 0.125rem 0.25rem rgba(13, 110, 253, 0.1);
        }
        
        .project-card.selected {
            border-color: var(--ses-primary);
            background-color: rgba(13, 110, 253, 0.1);
        }
        
        .skill-tag {
            display: inline-block;
            background: #e9ecef;
            color: #495057;
            padding: 0.25rem 0.5rem;
            margin: 0.125rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .skill-tag:hover {
            background: var(--ses-primary);
            color: white;
        }
        
        .skill-tag.selected {
            background: var(--ses-primary);
            color: white;
        }
        
        .criteria-section {
            background: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .weight-slider {
            width: 100%;
        }
        
        .algorithm-card {
            border: 2px solid #dee2e6;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .algorithm-card:hover {
            border-color: var(--ses-info);
        }
        
        .algorithm-card.selected {
            border-color: var(--ses-info);
            background-color: rgba(13, 202, 240, 0.1);
        }
        
        .matching-preview {
            background: linear-gradient(135deg, #0d6efd, #0a58ca);
            color: white;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
        }
        
        .preview-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .accordion-button:not(.collapsed) {
            background-color: rgba(13, 110, 253, 0.1);
            color: var(--ses-primary);
        }
    </style>
</head>
<body x-data="matchingSearch" x-cloak>
    
    <!-- ヘッダー -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container-fluid">
            <button class="btn btn-outline-secondary me-3" @click="toggleSidebar()">
                <i class="bi bi-list"></i>
            </button>
            <a class="navbar-brand" href="#">SES業務システム</a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle me-1"></i>山田太郎
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>プロフィール</a></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>設定</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-box-arrow-right me-2"></i>ログアウト</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- サイドバー -->
    <nav class="sidebar text-white">
        <div class="p-3">
            <ul class="nav nav-pills flex-column">
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-briefcase me-2"></i>案件管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-people me-2"></i>技術者管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white active" href="#">
                        <i class="bi bi-search-heart me-2"></i>マッチング
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-file-earmark-text me-2"></i>契約管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-clock me-2"></i>勤怠管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-receipt me-2"></i>請求管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-graph-up me-2"></i>レポート
                    </a>
                </li>
            </ul>
        </div>
    </nav>
    
    <!-- メインコンテンツ -->
    <main class="main-content">
        <div class="container-fluid p-4">
            <!-- ページヘッダー -->
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" class="text-decoration-none">マッチング</a></li>
                            <li class="breadcrumb-item active" aria-current="page">検索・条件設定</li>
                        </ol>
                    </nav>
                    <h1 class="h3 mb-2">マッチング検索・条件設定</h1>
                    <p class="text-muted mb-0">案件に最適な技術者を見つけるための条件を設定します</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary" @click="saveTemplate()">
                        <i class="bi bi-bookmark me-1"></i>テンプレート保存
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-collection me-1"></i>テンプレート読込
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" @click="loadTemplate('default')">
                                <i class="bi bi-gear me-2"></i>標準マッチング
                            </a></li>
                            <li><a class="dropdown-item" href="#" @click="loadTemplate('senior')">
                                <i class="bi bi-star me-2"></i>シニア技術者向け
                            </a></li>
                            <li><a class="dropdown-item" href="#" @click="loadTemplate('junior')">
                                <i class="bi bi-mortarboard me-2"></i>ジュニア技術者向け
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <form @submit.prevent="executeMatching()">
                <div class="row">
                    <div class="col-lg-8">
                        <!-- 案件選択 -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-briefcase me-2"></i>1. 案件選択
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <input type="text" class="form-control" placeholder="案件名で検索..." x-model="projectSearch">
                                </div>
                                <div class="row g-3">
                                    <template x-for="project in filteredProjects" :key="project.id">
                                        <div class="col-md-6">
                                            <div class="card project-card" 
                                                 :class="{ 'selected': selectedProject?.id === project.id }"
                                                 @click="selectProject(project)">
                                                <div class="card-body p-3">
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <h6 class="card-title mb-0" x-text="project.name"></h6>
                                                        <span class="badge bg-primary" x-text="project.status"></span>
                                                    </div>
                                                    <p class="card-text text-muted small mb-2" x-text="project.customer"></p>
                                                    <div class="small">
                                                        <div><strong>予算:</strong> <span x-text="formatCurrency(project.budget)"></span></div>
                                                        <div><strong>期間:</strong> <span x-text="`${project.startDate} 〜 ${project.endDate}`"></span></div>
                                                        <div><strong>スキル:</strong> <span x-text="project.skills.join(', ')"></span></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                        
                        <!-- マッチング条件設定 -->
                        <div class="card mb-4" x-show="selectedProject">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-sliders me-2"></i>2. マッチング条件設定
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- アコーディオン形式 -->
                                <div class="accordion" id="criteriaAccordion">
                                    <!-- スキル条件 -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#skillCriteria">
                                                <i class="bi bi-code-slash me-2"></i>スキル・技術要件
                                            </button>
                                        </h2>
                                        <div id="skillCriteria" class="accordion-collapse collapse show" data-bs-parent="#criteriaAccordion">
                                            <div class="accordion-body">
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label">必須スキル <span class="text-danger">*</span></label>
                                                        <div class="mb-3">
                                                            <template x-for="skill in availableSkills" :key="skill">
                                                                <span class="skill-tag" 
                                                                      :class="{ 'selected': criteria.requiredSkills.includes(skill) }"
                                                                      @click="toggleRequiredSkill(skill)"
                                                                      x-text="skill"></span>
                                                            </template>
                                                        </div>
                                                        <input type="text" class="form-control" placeholder="その他のスキル（カンマ区切り）" x-model="customRequiredSkills">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">優遇スキル</label>
                                                        <div class="mb-3">
                                                            <template x-for="skill in availableSkills" :key="skill">
                                                                <span class="skill-tag" 
                                                                      :class="{ 'selected': criteria.preferredSkills.includes(skill) }"
                                                                      @click="togglePreferredSkill(skill)"
                                                                      x-text="skill"></span>
                                                            </template>
                                                        </div>
                                                        <input type="text" class="form-control" placeholder="その他のスキル（カンマ区切り）" x-model="customPreferredSkills">
                                                    </div>
                                                </div>
                                                
                                                <div class="row g-3 mt-3">
                                                    <div class="col-md-4">
                                                        <label class="form-label">最小経験年数</label>
                                                        <select class="form-select" x-model="criteria.minExperience">
                                                            <option value="0">未経験可</option>
                                                            <option value="1">1年以上</option>
                                                            <option value="3">3年以上</option>
                                                            <option value="5">5年以上</option>
                                                            <option value="10">10年以上</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label">経験レベル</label>
                                                        <select class="form-select" x-model="criteria.skillLevel">
                                                            <option value="JUNIOR">ジュニア (1-2年)</option>
                                                            <option value="MIDDLE">ミドル (3-5年)</option>
                                                            <option value="SENIOR">シニア (5-10年)</option>
                                                            <option value="EXPERT">エキスパート (10年以上)</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label">スキル重要度</label>
                                                        <input type="range" class="form-range weight-slider" min="0" max="100" x-model="criteria.skillWeight">
                                                        <div class="text-center small" x-text="`${criteria.skillWeight}%`"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 稼働条件 -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#workConditions">
                                                <i class="bi bi-calendar-check me-2"></i>稼働・勤務条件
                                            </button>
                                        </h2>
                                        <div id="workConditions" class="accordion-collapse collapse" data-bs-parent="#criteriaAccordion">
                                            <div class="accordion-body">
                                                <div class="row g-3">
                                                    <div class="col-md-4">
                                                        <label class="form-label">稼働開始希望日</label>
                                                        <input type="date" class="form-control" x-model="criteria.startDate">
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label">最小稼働率</label>
                                                        <select class="form-select" x-model="criteria.minWorkload">
                                                            <option value="20">20%以上</option>
                                                            <option value="50">50%以上</option>
                                                            <option value="80">80%以上</option>
                                                            <option value="100">100%（専任）</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label">勤務重要度</label>
                                                        <input type="range" class="form-range weight-slider" min="0" max="100" x-model="criteria.workConditionWeight">
                                                        <div class="text-center small" x-text="`${criteria.workConditionWeight}%`"></div>
                                                    </div>
                                                </div>
                                                
                                                <div class="mt-3">
                                                    <label class="form-label">勤務形態</label>
                                                    <select class="form-select" x-model="criteria.workStyle">
                                                        <option value="ONSITE">客先常駐</option>
                                                        <option value="REMOTE">リモート</option>
                                                        <option value="HYBRID">ハイブリッド</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 評価・コスト条件 -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#evaluationCriteria">
                                                <i class="bi bi-star me-2"></i>評価・コスト条件
                                            </button>
                                        </h2>
                                        <div id="evaluationCriteria" class="accordion-collapse collapse" data-bs-parent="#criteriaAccordion">
                                            <div class="accordion-body">
                                                <div class="row g-3">
                                                    <div class="col-md-4">
                                                        <label class="form-label">最小評価点</label>
                                                        <select class="form-select" x-model="criteria.minRating">
                                                            <option value="0">指定なし</option>
                                                            <option value="3">3.0以上</option>
                                                            <option value="3.5">3.5以上</option>
                                                            <option value="4">4.0以上</option>
                                                            <option value="4.5">4.5以上</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label">最大時間単価</label>
                                                        <input type="number" class="form-control" x-model="criteria.maxHourlyRate" placeholder="円/時間">
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label">評価重要度</label>
                                                        <input type="range" class="form-range weight-slider" min="0" max="100" x-model="criteria.evaluationWeight">
                                                        <div class="text-center small" x-text="`${criteria.evaluationWeight}%`"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- アルゴリズム選択 -->
                        <div class="card mb-4" x-show="selectedProject">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-cpu me-2"></i>3. マッチングアルゴリズム選択
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <template x-for="algorithm in algorithms" :key="algorithm.id">
                                        <div class="col-md-4">
                                            <div class="card algorithm-card h-100" 
                                                 :class="{ 'selected': selectedAlgorithm?.id === algorithm.id }"
                                                 @click="selectAlgorithm(algorithm)">
                                                <div class="card-body text-center">
                                                    <i :class="algorithm.icon + ' text-info mb-2'" style="font-size: 2rem;"></i>
                                                    <h6 class="card-title" x-text="algorithm.name"></h6>
                                                    <p class="card-text small text-muted" x-text="algorithm.description"></p>
                                                    <div class="small">
                                                        <strong>精度:</strong> <span x-text="algorithm.accuracy"></span><br>
                                                        <strong>速度:</strong> <span x-text="algorithm.speed"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 詳細設定 -->
                        <div class="card mb-4" x-show="selectedProject">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-gear me-2"></i>4. 詳細設定
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">最大候補者数</label>
                                        <select class="form-select" x-model="criteria.maxCandidates">
                                            <option value="10">10名</option>
                                            <option value="20">20名</option>
                                            <option value="50">50名</option>
                                            <option value="100">100名</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">最小マッチング スコア</label>
                                        <input type="range" class="form-range" min="0" max="100" x-model="criteria.minMatchingScore">
                                        <div class="text-center small" x-text="`${criteria.minMatchingScore}%以上`"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">除外条件</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" x-model="criteria.excludeCurrentlyAssigned">
                                            <label class="form-check-label">現在稼働中の技術者を除外</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" x-model="criteria.excludePastRejected">
                                            <label class="form-check-label">過去に断った技術者を除外</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- サイドパネル -->
                    <div class="col-lg-4">
                        <!-- 選択中の案件 -->
                        <div class="card mb-4" x-show="selectedProject">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-info-circle me-2"></i>選択中の案件
                                </h6>
                            </div>
                            <div class="card-body">
                                <template x-if="selectedProject">
                                    <div>
                                        <h6 x-text="selectedProject.name"></h6>
                                        <p class="text-muted small mb-2" x-text="selectedProject.customer"></p>
                                        <div class="small">
                                            <div><strong>ステータス:</strong> <span x-text="selectedProject.status"></span></div>
                                            <div><strong>予算:</strong> <span x-text="formatCurrency(selectedProject.budget)"></span></div>
                                            <div><strong>期間:</strong> <span x-text="`${selectedProject.startDate} 〜 ${selectedProject.endDate}`"></span></div>
                                            <div><strong>必要スキル:</strong></div>
                                            <div class="mt-1">
                                                <template x-for="skill in selectedProject.skills" :key="skill">
                                                    <span class="badge bg-secondary me-1" x-text="skill"></span>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- マッチング予測 -->
                        <div class="card mb-4" x-show="selectedProject">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-graph-up me-2"></i>マッチング予測
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="matching-preview">
                                    <div class="preview-number" x-text="estimatedCandidates"></div>
                                    <div>候補者見込み</div>
                                </div>
                                <div class="mt-3 small">
                                    <div class="d-flex justify-content-between">
                                        <span>高適合度候補:</span>
                                        <span class="fw-medium" x-text="`約${Math.floor(estimatedCandidates * 0.3)}名`"></span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>中適合度候補:</span>
                                        <span class="fw-medium" x-text="`約${Math.floor(estimatedCandidates * 0.5)}名`"></span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>低適合度候補:</span>
                                        <span class="fw-medium" x-text="`約${Math.floor(estimatedCandidates * 0.2)}名`"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 実行ボタン -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" :disabled="!selectedProject || loading">
                                <template x-if="!loading">
                                    <span><i class="bi bi-search me-2"></i>マッチング実行</span>
                                </template>
                                <template x-if="loading">
                                    <span>
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                        マッチング中...
                                    </span>
                                </template>
                            </button>
                            
                            <button type="button" class="btn btn-outline-secondary" @click="previewMatching()" :disabled="!selectedProject">
                                <i class="bi bi-eye me-2"></i>プレビュー
                            </button>
                            
                            <button type="button" class="btn btn-outline-info" @click="resetCriteria()">
                                <i class="bi bi-arrow-clockwise me-2"></i>条件リセット
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </main>
    
    <!-- JavaScript -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('matchingSearch', () => ({
                projectSearch: '',
                customRequiredSkills: '',
                customPreferredSkills: '',
                loading: false,
                
                selectedProject: null,
                selectedAlgorithm: null,
                
                projects: [
                    {
                        id: '123e4567-e89b-12d3-a456-426614174000',
                        name: 'ECサイトリニューアル',
                        customer: '株式会社ABC商事',
                        status: 'ORDERED',
                        budget: {
                            min: 7000000,
                            max: 9000000,
                            currency: 'JPY'
                        },
                        startDate: '2025-04-01',
                        endDate: '2025-09-30',
                        skills: ['Java', 'Spring Boot', 'React', 'PostgreSQL']
                    },
                    {
                        id: '456e7890-e89b-12d3-a456-426614174001',
                        name: '基幹システム更改',
                        customer: 'XYZ製造株式会社',
                        status: 'PROPOSING',
                        budget: {
                            min: 12000000,
                            max: 18000000,
                            currency: 'JPY'
                        },
                        startDate: '2025-07-01',
                        endDate: '2026-03-31',
                        skills: ['C#', '.NET Core', 'SQL Server', 'Angular']
                    },
                    {
                        id: '789e0123-e89b-12d3-a456-426614174002',
                        name: 'モバイルアプリ開発',
                        customer: '株式会社DEFモバイル',
                        status: 'INQUIRY',
                        budget: {
                            min: 4000000,
                            max: 6000000,
                            currency: 'JPY'
                        },
                        startDate: '2025-08-01',
                        endDate: '2025-12-31',
                        skills: ['React Native', 'TypeScript', 'Firebase']
                    }
                ],
                
                availableSkills: [
                    'Java', 'Python', 'C#', 'JavaScript', 'TypeScript', 'React', 'Angular', 'Vue.js',
                    'Spring Boot', '.NET Core', 'Node.js', 'PostgreSQL', 'MySQL', 'MongoDB',
                    'AWS', 'Azure', 'Docker', 'Kubernetes'
                ],
                
                algorithms: [
                    {
                        id: 'standard',
                        name: '標準マッチング',
                        description: 'スキルマッチと稼働状況のバランス重視',
                        icon: 'bi bi-gear',
                        accuracy: '高',
                        speed: '普通'
                    },
                    {
                        id: 'ai_enhanced',
                        name: 'AI強化マッチング',
                        description: '機械学習による過去実績考慮',
                        icon: 'bi bi-cpu',
                        accuracy: '最高',
                        speed: '遅'
                    },
                    {
                        id: 'quick',
                        name: 'クイックマッチング',
                        description: '基本条件のみで高速マッチング',
                        icon: 'bi bi-lightning',
                        accuracy: '普通',
                        speed: '高'
                    }
                ],
                
                criteria: {
                    requiredSkills: [],
                    preferredSkills: [],
                    minExperience: 0,
                    skillLevel: 'MIDDLE',
                    skillWeight: 70,
                    startDate: '',
                    minWorkload: 50,
                    workConditionWeight: 60,
                    workStyle: 'HYBRID',
                    minRating: 0,
                    maxHourlyRate: '',
                    evaluationWeight: 50,
                    maxCandidates: 20,
                    minMatchingScore: 60,
                    excludeCurrentlyAssigned: true,
                    excludePastRejected: false
                },
                
                init() {
                    this.selectedAlgorithm = this.algorithms[0];
                },
                
                get filteredProjects() {
                    if (!this.projectSearch) return this.projects;
                    return this.projects.filter(p => 
                        p.name.toLowerCase().includes(this.projectSearch.toLowerCase()) ||
                        p.customer.toLowerCase().includes(this.projectSearch.toLowerCase())
                    );
                },
                
                get estimatedCandidates() {
                    if (!this.selectedProject) return 0;
                    
                    let base = 50; // 基本候補者数
                    
                    // スキル要件による減算
                    base -= this.criteria.requiredSkills.length * 5;
                    
                    // 経験年数による減算
                    base -= this.criteria.minExperience * 3;
                    
                    // 稼働率による減算
                    base -= (this.criteria.minWorkload - 50) / 10;
                    
                    // 最小マッチングスコアによる減算
                    base -= (this.criteria.minMatchingScore - 50) / 10;
                    
                    return Math.max(5, Math.min(100, Math.floor(base)));
                },
                
                selectProject(project) {
                    this.selectedProject = project;
                    // 案件のスキルを必須スキルに自動設定
                    this.criteria.requiredSkills = [...project.skills];
                },
                
                selectAlgorithm(algorithm) {
                    this.selectedAlgorithm = algorithm;
                },
                
                toggleRequiredSkill(skill) {
                    const index = this.criteria.requiredSkills.indexOf(skill);
                    if (index > -1) {
                        this.criteria.requiredSkills.splice(index, 1);
                    } else {
                        this.criteria.requiredSkills.push(skill);
                    }
                },
                
                togglePreferredSkill(skill) {
                    const index = this.criteria.preferredSkills.indexOf(skill);
                    if (index > -1) {
                        this.criteria.preferredSkills.splice(index, 1);
                    } else {
                        this.criteria.preferredSkills.push(skill);
                    }
                },
                
                executeMatching() {
                    if (!this.selectedProject) {
                        alert('案件を選択してください');
                        return;
                    }
                    
                    this.loading = true;
                    
                    // API仕様準拠のマッチング要求データを準備
                    const requestData = {
                        projectId: this.selectedProject.id,
                        requirements: {
                            requiredSkills: this.criteria.requiredSkills.map(skill => ({
                                name: skill,
                                requiredLevel: 3, // デフォルトレベル
                                weight: 0.7,
                                mandatory: true
                            })),
                            experienceLevel: this.criteria.skillLevel,
                            workStyle: this.criteria.workStyle,
                            projectDuration: Math.ceil((new Date(this.selectedProject.endDate) - new Date(this.selectedProject.startDate)) / (30 * 24 * 60 * 60 * 1000)),
                            startDate: this.criteria.startDate || this.selectedProject.startDate,
                            budget: this.selectedProject.budget,
                            teamSize: 1,
                            specialRequirements: [],
                            candidateLimit: this.criteria.maxCandidates
                        },
                        deadline: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString(), // 2週間後
                        priority: 'MEDIUM',
                        autoExecute: true
                    };
                    
                    console.log('マッチング要求作成 (API準拠):', requestData);
                    
                    // 実際のAPI呼び出し: POST /matching-requests → POST /matching-requests/{requestId}/execute
                    setTimeout(() => {
                        this.loading = false;
                        alert('マッチング要求を作成し、実行しました。結果画面に移動します。');
                        // 実際の実装では結果画面にリダイレクト
                    }, 3000);
                },
                
                previewMatching() {
                    console.log('マッチングプレビュー:', {
                        project: this.selectedProject,
                        criteria: this.criteria,
                        estimatedResults: this.estimatedCandidates
                    });
                    alert(`予測候補者数: ${this.estimatedCandidates}名`);
                },
                
                resetCriteria() {
                    this.criteria = {
                        requiredSkills: this.selectedProject ? [...this.selectedProject.skills] : [],
                        preferredSkills: [],
                        minExperience: 0,
                        skillLevel: 'MIDDLE',
                        skillWeight: 70,
                        startDate: '',
                        minWorkload: 50,
                        workConditionWeight: 60,
                        workStyle: 'HYBRID',
                        minRating: 0,
                        maxHourlyRate: '',
                        evaluationWeight: 50,
                        maxCandidates: 20,
                        minMatchingScore: 60,
                        excludeCurrentlyAssigned: true,
                        excludePastRejected: false
                    };
                },
                
                saveTemplate() {
                    const templateData = {
                        criteria: this.criteria,
                        algorithm: this.selectedAlgorithm
                    };
                    console.log('テンプレート保存:', templateData);
                    alert('マッチング条件をテンプレートとして保存しました');
                },
                
                loadTemplate(templateName) {
                    console.log('テンプレート読込:', templateName);
                    // 実際の実装ではAPIからテンプレート取得
                    alert(`${templateName}テンプレートを読み込みました`);
                },
                
                formatCurrency(budgetObj) {
                    if (typeof budgetObj === 'object' && budgetObj.min && budgetObj.max) {
                        const min = new Intl.NumberFormat('ja-JP', {
                            style: 'currency',
                            currency: budgetObj.currency || 'JPY'
                        }).format(budgetObj.min);
                        const max = new Intl.NumberFormat('ja-JP', {
                            style: 'currency', 
                            currency: budgetObj.currency || 'JPY'
                        }).format(budgetObj.max);
                        return `${min} 〜 ${max}`;
                    }
                    return new Intl.NumberFormat('ja-JP', {
                        style: 'currency',
                        currency: 'JPY'
                    }).format(budgetObj || 0);
                }
            }));
        });
    </script>
</body>
</html>