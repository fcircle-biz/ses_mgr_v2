<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マッチング評価・判定 - SES業務システム</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    
    <!-- カスタムCSS -->
    <style>
        :root {
            --sidebar-width: 280px;
            --header-height: 60px;
            --ses-primary: #0d6efd;
            --ses-secondary: #6c757d;
            --ses-success: #198754;
            --ses-warning: #ffc107;
            --ses-danger: #dc3545;
            --ses-light: #f8f9fa;
        }
        
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: var(--header-height);
            min-height: calc(100vh - var(--header-height));
        }
        
        .sidebar {
            position: fixed;
            top: var(--header-height);
            left: 0;
            width: var(--sidebar-width);
            height: calc(100vh - var(--header-height));
            background-color: #212529;
            z-index: 1000;
        }
        
        .navbar {
            height: var(--header-height);
            background-color: #ffffff !important;
            border-bottom: 1px solid #dee2e6;
        }
        
        .candidate-nav {
            background: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .candidate-tab {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 120px;
            text-align: center;
        }
        
        .candidate-tab:hover {
            border-color: var(--ses-primary);
        }
        
        .candidate-tab.active {
            border-color: var(--ses-primary);
            background: rgba(13, 110, 253, 0.1);
        }
        
        .candidate-tab.approved {
            border-color: var(--ses-success);
            background: rgba(25, 135, 84, 0.1);
        }
        
        .candidate-tab.rejected {
            border-color: var(--ses-danger);
            background: rgba(220, 53, 69, 0.1);
        }
        
        .evaluation-section {
            background: white;
            border-radius: 0.5rem;
            border: 1px solid #dee2e6;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .skill-evaluation {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }
        
        .skill-level {
            display: flex;
            gap: 0.25rem;
        }
        
        .skill-star {
            width: 20px;
            height: 20px;
            cursor: pointer;
            color: #dee2e6;
            transition: color 0.2s;
        }
        
        .skill-star.filled {
            color: #ffc107;
        }
        
        .skill-star:hover {
            color: #ffc107;
        }
        
        .evaluation-criteria {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            margin-bottom: 0.75rem;
        }
        
        .criteria-weight {
            text-align: center;
            font-weight: 500;
        }
        
        .score-display {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .score-excellent {
            background: linear-gradient(135deg, #198754, #20c997);
            color: white;
        }
        
        .score-good {
            background: linear-gradient(135deg, #ffc107, #ffcd39);
            color: #000;
        }
        
        .score-fair {
            background: linear-gradient(135deg, #fd7e14, #fd8c28);
            color: white;
        }
        
        .score-poor {
            background: linear-gradient(135deg, #dc3545, #e55353);
            color: white;
        }
        
        .decision-panel {
            background: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1.5rem;
            border: 2px solid #dee2e6;
        }
        
        .decision-button {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 500;
            border-radius: 0.5rem;
            border: 2px solid;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            margin-bottom: 0.75rem;
        }
        
        .decision-approve {
            background: white;
            border-color: var(--ses-success);
            color: var(--ses-success);
        }
        
        .decision-approve:hover,
        .decision-approve.selected {
            background: var(--ses-success);
            color: white;
        }
        
        .decision-reject {
            background: white;
            border-color: var(--ses-danger);
            color: var(--ses-danger);
        }
        
        .decision-reject:hover,
        .decision-reject.selected {
            background: var(--ses-danger);
            color: white;
        }
        
        .decision-pending {
            background: white;
            border-color: var(--ses-warning);
            color: var(--ses-warning);
        }
        
        .decision-pending:hover,
        .decision-pending.selected {
            background: var(--ses-warning);
            color: #000;
        }
        
        .timeline-item {
            position: relative;
            padding-left: 2rem;
            padding-bottom: 1rem;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0.5rem;
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            background: var(--ses-primary);
        }
        
        .timeline-item:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 0.875rem;
            top: 1.25rem;
            width: 2px;
            height: calc(100% - 0.75rem);
            background: #dee2e6;
        }
        
        .comparison-table {
            background: white;
            border-radius: 0.5rem;
            border: 1px solid #dee2e6;
            overflow: hidden;
        }
        
        .comparison-header {
            background: var(--ses-light);
            padding: 1rem;
            font-weight: 500;
            border-bottom: 1px solid #dee2e6;
        }
        
        .comparison-row {
            display: grid;
            grid-template-columns: 2fr repeat(3, 1fr);
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .comparison-row:last-child {
            border-bottom: none;
        }
        
        .progress-ring {
            width: 60px;
            height: 60px;
            position: relative;
        }
        
        .progress-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        
        .progress-ring circle {
            fill: none;
            stroke-width: 6;
            r: 24;
            cx: 30;
            cy: 30;
        }
        
        .progress-ring .background {
            stroke: #e9ecef;
        }
        
        .progress-ring .progress {
            stroke: var(--ses-primary);
            stroke-linecap: round;
            stroke-dasharray: 150.8;
            stroke-dashoffset: 150.8;
            transition: stroke-dashoffset 0.5s ease;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.875rem;
            font-weight: bold;
        }
    </style>
</head>
<body x-data="evaluationJudgment" x-cloak>
    
    <!-- ヘッダー -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container-fluid">
            <button class="btn btn-outline-secondary me-3" @click="toggleSidebar()">
                <i class="bi bi-list"></i>
            </button>
            <a class="navbar-brand" href="#">SES業務システム</a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle me-1"></i>山田太郎
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>プロフィール</a></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>設定</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-box-arrow-right me-2"></i>ログアウト</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- サイドバー -->
    <nav class="sidebar text-white">
        <div class="p-3">
            <ul class="nav nav-pills flex-column">
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-briefcase me-2"></i>案件管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-people me-2"></i>技術者管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white active" href="#">
                        <i class="bi bi-search-heart me-2"></i>マッチング
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-file-earmark-text me-2"></i>契約管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-clock me-2"></i>勤怠管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-receipt me-2"></i>請求管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white-50" href="#">
                        <i class="bi bi-graph-up me-2"></i>レポート
                    </a>
                </li>
            </ul>
        </div>
    </nav>
    
    <!-- メインコンテンツ -->
    <main class="main-content">
        <div class="container-fluid p-4">
            <!-- ページヘッダー -->
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" class="text-decoration-none">マッチング</a></li>
                            <li class="breadcrumb-item"><a href="#" class="text-decoration-none">検索・条件設定</a></li>
                            <li class="breadcrumb-item"><a href="#" class="text-decoration-none">マッチング結果</a></li>
                            <li class="breadcrumb-item active" aria-current="page">評価・判定</li>
                        </ol>
                    </nav>
                    <h1 class="h3 mb-2">マッチング評価・判定</h1>
                    <p class="text-muted mb-0">
                        <span x-text="project.name"></span> - 候補者の詳細評価と採用判定
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary" @click="saveEvaluations()">
                        <i class="bi bi-cloud-upload me-1"></i>評価保存
                    </button>
                    <button class="btn btn-outline-primary" @click="compareAll()">
                        <i class="bi bi-bar-chart me-1"></i>候補者比較
                    </button>
                    <button class="btn btn-success" @click="finalizeDecisions()" :disabled="!hasDecisions()">
                        <i class="bi bi-check-circle me-1"></i>判定確定
                    </button>
                </div>
            </div>
            
            <!-- 候補者ナビゲーション -->
            <div class="candidate-nav">
                <div class="d-flex flex-wrap align-items-center">
                    <span class="me-3 fw-medium">候補者:</span>
                    <template x-for="candidate in candidates" :key="candidate.id">
                        <div class="candidate-tab" 
                             :class="{ 
                                 'active': currentCandidateId === candidate.id,
                                 'approved': candidate.decision === 'approve',
                                 'rejected': candidate.decision === 'reject'
                             }"
                             @click="selectCandidate(candidate.id)">
                            <div class="fw-medium" x-text="candidate.name"></div>
                            <div class="small">
                                <span x-text="`${candidate.totalScore}%`"></span>
                                <template x-if="candidate.decision">
                                    <i class="ms-1" :class="{
                                        'bi bi-check-circle text-success': candidate.decision === 'approve',
                                        'bi bi-x-circle text-danger': candidate.decision === 'reject',
                                        'bi bi-clock text-warning': candidate.decision === 'pending'
                                    }"></i>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <div class="row" x-show="currentCandidate">
                <div class="col-lg-8">
                    <!-- 候補者基本情報 -->
                    <div class="evaluation-section">
                        <div class="d-flex align-items-center mb-3">
                            <img :src="currentCandidate?.avatar" class="rounded-circle me-3" width="64" height="64">
                            <div class="flex-grow-1">
                                <h4 x-text="currentCandidate?.name"></h4>
                                <p class="text-muted mb-1" x-text="currentCandidate?.title"></p>
                                <div class="d-flex align-items-center gap-3">
                                    <span class="badge bg-primary" x-text="`マッチング度 ${currentCandidate?.matchingScore}%`"></span>
                                    <span class="small">
                                        <i class="bi bi-star-fill text-warning me-1"></i>
                                        <span x-text="currentCandidate?.rating"></span>
                                    </span>
                                    <span class="small">
                                        <i class="bi bi-briefcase me-1"></i>
                                        <span x-text="`${currentCandidate?.totalExperience}年経験`"></span>
                                    </span>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="score-display" :class="getTotalScoreClass(currentCandidate?.totalScore)">
                                    <div x-text="`${currentCandidate?.totalScore}%`"></div>
                                    <div class="fs-6">総合評価</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- スキル評価 -->
                    <div class="evaluation-section">
                        <h5 class="mb-3">
                            <i class="bi bi-code-slash me-2"></i>スキル評価
                        </h5>
                        <template x-for="skill in currentCandidate?.skillEvaluations" :key="skill.name">
                            <div class="skill-evaluation">
                                <div class="flex-grow-1">
                                    <div class="fw-medium" x-text="skill.name"></div>
                                    <div class="small text-muted" x-text="`要求レベル: ${skill.requiredLevel} | 現在レベル: ${skill.currentLevel}`"></div>
                                </div>
                                <div class="skill-level">
                                    <template x-for="star in 5" :key="star">
                                        <i class="bi bi-star-fill skill-star" 
                                           :class="{ 'filled': star <= skill.rating }"
                                           @click="updateSkillRating(skill.name, star)"></i>
                                    </template>
                                </div>
                                <div class="text-end">
                                    <span class="fw-medium" x-text="`${skill.score}%`"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <!-- 総合評価基準 -->
                    <div class="evaluation-section">
                        <h5 class="mb-3">
                            <i class="bi bi-clipboard-check me-2"></i>総合評価基準
                        </h5>
                        <template x-for="criteria in evaluationCriteria" :key="criteria.name">
                            <div class="evaluation-criteria">
                                <div>
                                    <div class="fw-medium" x-text="criteria.name"></div>
                                    <div class="small text-muted" x-text="criteria.description"></div>
                                </div>
                                <div>
                                    <input type="range" class="form-range" min="0" max="100" 
                                           x-model="criteria.score" @input="updateTotalScore()">
                                    <div class="d-flex justify-content-between small text-muted">
                                        <span>0</span>
                                        <span x-text="criteria.score"></span>
                                        <span>100</span>
                                    </div>
                                </div>
                                <div class="criteria-weight" x-text="`重み: ${criteria.weight}%`"></div>
                            </div>
                        </template>
                    </div>
                    
                    <!-- 評価コメント -->
                    <div class="evaluation-section">
                        <h5 class="mb-3">
                            <i class="bi bi-chat-text me-2"></i>評価コメント
                        </h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">強み・アピールポイント</label>
                                <textarea class="form-control" rows="4" 
                                          x-model="currentCandidate.strengths"
                                          placeholder="候補者の強みや優れている点を記入してください"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">懸念点・課題</label>
                                <textarea class="form-control" rows="4" 
                                          x-model="currentCandidate.concerns"
                                          placeholder="懸念される点や改善が必要な課題を記入してください"></textarea>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">総合コメント</label>
                            <textarea class="form-control" rows="3" 
                                      x-model="currentCandidate.overallComment"
                                      placeholder="総合的な評価コメントを記入してください"></textarea>
                        </div>
                    </div>
                    
                    <!-- 判定 -->
                    <div class="decision-panel">
                        <h5 class="mb-3">
                            <i class="bi bi-gavel me-2"></i>最終判定
                        </h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="decision-button decision-approve" 
                                     :class="{ 'selected': currentCandidate?.decision === 'approve' }"
                                     @click="setDecision('approve')">
                                    <i class="bi bi-check-circle-fill mb-2 d-block"></i>
                                    <div class="fw-medium">採用提案</div>
                                    <div class="small">推薦して次のステップへ</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="decision-button decision-pending" 
                                     :class="{ 'selected': currentCandidate?.decision === 'pending' }"
                                     @click="setDecision('pending')">
                                    <i class="bi bi-clock-fill mb-2 d-block"></i>
                                    <div class="fw-medium">保留</div>
                                    <div class="small">追加検討が必要</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="decision-button decision-reject" 
                                     :class="{ 'selected': currentCandidate?.decision === 'reject' }"
                                     @click="setDecision('reject')">
                                    <i class="bi bi-x-circle-fill mb-2 d-block"></i>
                                    <div class="fw-medium">不採用</div>
                                    <div class="small">今回は見送り</div>
                                </div>
                            </div>
                        </div>
                        
                        <div x-show="currentCandidate?.decision" class="mt-3">
                            <label class="form-label">判定理由</label>
                            <textarea class="form-control" rows="2" 
                                      x-model="currentCandidate.decisionReason"
                                      placeholder="判定の理由を記入してください"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- サイドパネル -->
                <div class="col-lg-4">
                    <!-- 評価サマリー -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="bi bi-speedometer me-2"></i>評価サマリー
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 text-center">
                                <div class="col-6">
                                    <div class="progress-ring">
                                        <svg>
                                            <circle class="background"></circle>
                                            <circle class="progress" :style="`stroke-dashoffset: ${150.8 - (150.8 * (currentCandidate?.skillScore || 0) / 100)}`"></circle>
                                        </svg>
                                        <div class="progress-text" x-text="`${currentCandidate?.skillScore || 0}%`"></div>
                                    </div>
                                    <div class="small text-muted mt-2">スキル</div>
                                </div>
                                <div class="col-6">
                                    <div class="progress-ring">
                                        <svg>
                                            <circle class="background"></circle>
                                            <circle class="progress" :style="`stroke-dashoffset: ${150.8 - (150.8 * (currentCandidate?.experienceScore || 0) / 100)}`"></circle>
                                        </svg>
                                        <div class="progress-text" x-text="`${currentCandidate?.experienceScore || 0}%`"></div>
                                    </div>
                                    <div class="small text-muted mt-2">経験</div>
                                </div>
                                <div class="col-6">
                                    <div class="progress-ring">
                                        <svg>
                                            <circle class="background"></circle>
                                            <circle class="progress" :style="`stroke-dashoffset: ${150.8 - (150.8 * (currentCandidate?.availabilityScore || 0) / 100)}`"></circle>
                                        </svg>
                                        <div class="progress-text" x-text="`${currentCandidate?.availabilityScore || 0}%`"></div>
                                    </div>
                                    <div class="small text-muted mt-2">稼働性</div>
                                </div>
                                <div class="col-6">
                                    <div class="progress-ring">
                                        <svg>
                                            <circle class="background"></circle>
                                            <circle class="progress" :style="`stroke-dashoffset: ${150.8 - (150.8 * (currentCandidate?.costScore || 0) / 100)}`"></circle>
                                        </svg>
                                        <div class="progress-text" x-text="`${currentCandidate?.costScore || 0}%`"></div>
                                    </div>
                                    <div class="small text-muted mt-2">コスト</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 評価履歴 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="bi bi-clock-history me-2"></i>評価履歴
                            </h6>
                        </div>
                        <div class="card-body">
                            <template x-for="history in currentCandidate?.evaluationHistory" :key="history.id">
                                <div class="timeline-item">
                                    <div class="small">
                                        <div class="fw-medium" x-text="history.action"></div>
                                        <div class="text-muted" x-text="history.user"></div>
                                        <div class="text-muted" x-text="formatDateTime(history.timestamp)"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- 参考情報 -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="bi bi-info-circle me-2"></i>参考情報
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="small">
                                <div class="mb-2">
                                    <strong>過去の案件数:</strong> <span x-text="currentCandidate?.pastProjects || 0"></span>件
                                </div>
                                <div class="mb-2">
                                    <strong>平均評価:</strong> <span x-text="currentCandidate?.averageRating || 0"></span>/5.0
                                </div>
                                <div class="mb-2">
                                    <strong>継続率:</strong> <span x-text="currentCandidate?.continuationRate || 0"></span>%
                                </div>
                                <div class="mb-2">
                                    <strong>前回参画:</strong> <span x-text="formatDate(currentCandidate?.lastProjectDate)"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- 候補者比較モーダル -->
    <div class="modal fade" id="comparisonModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">候補者比較</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="comparison-table">
                        <div class="comparison-header">候補者比較表</div>
                        <div class="comparison-row">
                            <div><strong>項目</strong></div>
                            <template x-for="candidate in candidates.slice(0, 3)" :key="candidate.id">
                                <div class="text-center">
                                    <strong x-text="candidate.name"></strong>
                                </div>
                            </template>
                        </div>
                        <div class="comparison-row">
                            <div>総合評価</div>
                            <template x-for="candidate in candidates.slice(0, 3)" :key="candidate.id">
                                <div class="text-center">
                                    <span class="fw-bold" x-text="`${candidate.totalScore}%`"></span>
                                </div>
                            </template>
                        </div>
                        <div class="comparison-row">
                            <div>スキルマッチング</div>
                            <template x-for="candidate in candidates.slice(0, 3)" :key="candidate.id">
                                <div class="text-center" x-text="`${candidate.skillScore}%`"></div>
                            </template>
                        </div>
                        <div class="comparison-row">
                            <div>経験年数</div>
                            <template x-for="candidate in candidates.slice(0, 3)" :key="candidate.id">
                                <div class="text-center" x-text="`${candidate.totalExperience}年`"></div>
                            </template>
                        </div>
                        <div class="comparison-row">
                            <div>時間単価</div>
                            <template x-for="candidate in candidates.slice(0, 3)" :key="candidate.id">
                                <div class="text-center" x-text="`¥${candidate.hourlyRate.toLocaleString()}`"></div>
                            </template>
                        </div>
                        <div class="comparison-row">
                            <div>稼働可能度</div>
                            <template x-for="candidate in candidates.slice(0, 3)" :key="candidate.id">
                                <div class="text-center" x-text="`${candidate.availabilityScore}%`"></div>
                            </template>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">閉じる</button>
                    <button type="button" class="btn btn-primary" @click="exportComparison()">比較表エクスポート</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('evaluationJudgment', () => ({
                currentCandidateId: '456e7890-e89b-12d3-a456-426614174001',
                
                project: {
                    id: '123e4567-e89b-12d3-a456-426614174000',
                    name: 'ECサイトリニューアル',
                    customer: '株式会社ABC商事'
                },
                
                evaluationCriteria: [
                    { name: 'スキル適合度', description: '必要スキルとの適合度', score: 85, weight: 40 },
                    { name: '経験・実績', description: '関連する経験と実績', score: 78, weight: 30 },
                    { name: '稼働可能性', description: '時期・稼働率の適合', score: 90, weight: 20 },
                    { name: 'コスト効率', description: '予算に対するコスト効率', score: 75, weight: 10 }
                ],
                
                candidates: [
                    {
                        id: '456e7890-e89b-12d3-a456-426614174001',
                        name: '山田太郎',
                        title: 'シニアエンジニア',
                        avatar: 'https://via.placeholder.com/64',
                        matchingScore: 92,
                        status: 'REVIEWED',
                        experienceLevel: 'SENIOR',
                        rating: 4.5,
                        totalExperience: 8,
                        hourlyRate: 8000,
                        totalScore: 87,
                        skillScore: 85,
                        experienceScore: 88,
                        availabilityScore: 90,
                        costScore: 75,
                        decision: null,
                        decisionReason: '',
                        strengths: '',
                        concerns: '',
                        overallComment: '',
                        pastProjects: 15,
                        averageRating: 4.3,
                        continuationRate: 85,
                        lastProjectDate: '2025-03-31',
                        skillEvaluations: [
                            { name: 'Java', requiredLevel: '上級', currentLevel: '上級', rating: 5, score: 95 },
                            { name: 'Spring Boot', requiredLevel: '中級', currentLevel: '上級', rating: 5, score: 100 },
                            { name: 'React', requiredLevel: '中級', currentLevel: '初級', rating: 3, score: 60 },
                            { name: 'PostgreSQL', requiredLevel: '中級', currentLevel: '上級', rating: 4, score: 85 }
                        ],
                        evaluationHistory: [
                            { id: 1, action: '評価開始', user: '田中PM', timestamp: '2025-06-01T10:00:00' },
                            { id: 2, action: 'スキル評価完了', user: '佐藤TL', timestamp: '2025-06-01T14:30:00' }
                        ]
                    },
                    {
                        id: '789e0123-e89b-12d3-a456-426614174002',
                        name: '佐藤花子',
                        title: 'フルスタックエンジニア',
                        avatar: 'https://via.placeholder.com/64',
                        matchingScore: 88,
                        status: 'SHORTLISTED',
                        experienceLevel: 'MIDDLE',
                        rating: 4.2,
                        totalExperience: 6,
                        hourlyRate: 7500,
                        totalScore: 83,
                        skillScore: 88,
                        experienceScore: 75,
                        availabilityScore: 95,
                        costScore: 85,
                        decision: null,
                        decisionReason: '',
                        strengths: '',
                        concerns: '',
                        overallComment: '',
                        pastProjects: 12,
                        averageRating: 4.1,
                        continuationRate: 90,
                        lastProjectDate: '2025-04-15',
                        skillEvaluations: [
                            { name: 'Java', requiredLevel: '上級', currentLevel: '中級', rating: 4, score: 80 },
                            { name: 'Spring Boot', requiredLevel: '中級', currentLevel: '中級', rating: 4, score: 85 },
                            { name: 'React', requiredLevel: '中級', currentLevel: '上級', rating: 5, score: 100 },
                            { name: 'PostgreSQL', requiredLevel: '中級', currentLevel: '初級', rating: 3, score: 60 }
                        ],
                        evaluationHistory: [
                            { id: 1, action: '評価開始', user: '田中PM', timestamp: '2025-06-01T10:30:00' }
                        ]
                    },
                    {
                        id: 'abc1234f-e89b-12d3-a456-426614174003',
                        name: '田中一郎',
                        title: 'バックエンドエンジニア',
                        avatar: 'https://via.placeholder.com/64',
                        matchingScore: 85,
                        status: 'GENERATED',
                        experienceLevel: 'EXPERT',
                        rating: 4.7,
                        totalExperience: 10,
                        hourlyRate: 9000,
                        totalScore: 79,
                        skillScore: 90,
                        experienceScore: 95,
                        availabilityScore: 60,
                        costScore: 65,
                        decision: null,
                        decisionReason: '',
                        strengths: '',
                        concerns: '',
                        overallComment: '',
                        pastProjects: 20,
                        averageRating: 4.5,
                        continuationRate: 80,
                        lastProjectDate: '2025-05-20',
                        skillEvaluations: [
                            { name: 'Java', requiredLevel: '上級', currentLevel: 'エキスパート', rating: 5, score: 100 },
                            { name: 'Spring Boot', requiredLevel: '中級', currentLevel: '上級', rating: 5, score: 100 },
                            { name: 'React', requiredLevel: '中級', currentLevel: '未経験', rating: 1, score: 20 },
                            { name: 'PostgreSQL', requiredLevel: '中級', currentLevel: '上級', rating: 5, score: 95 }
                        ],
                        evaluationHistory: [
                            { id: 1, action: '評価開始', user: '田中PM', timestamp: '2025-06-01T11:00:00' }
                        ]
                    }
                ],
                
                get currentCandidate() {
                    return this.candidates.find(c => c.id === this.currentCandidateId);
                },
                
                selectCandidate(candidateId) {
                    this.currentCandidateId = candidateId;
                },
                
                updateSkillRating(skillName, rating) {
                    const candidate = this.currentCandidate;
                    const skill = candidate.skillEvaluations.find(s => s.name === skillName);
                    if (skill) {
                        skill.rating = rating;
                        skill.score = rating * 20; // 5段階評価を100点満点に変換
                        this.updateTotalScore();
                    }
                },
                
                updateTotalScore() {
                    // 評価基準の重み付き平均を計算
                    let totalWeight = 0;
                    let weightedSum = 0;
                    
                    this.evaluationCriteria.forEach(criteria => {
                        weightedSum += criteria.score * criteria.weight / 100;
                        totalWeight += criteria.weight;
                    });
                    
                    this.currentCandidate.totalScore = Math.round(weightedSum);
                },
                
                setDecision(decision) {
                    this.currentCandidate.decision = decision;
                    
                    // 評価履歴に追加
                    this.currentCandidate.evaluationHistory.push({
                        id: Date.now(),
                        action: `判定: ${this.getDecisionText(decision)}`,
                        user: '山田太郎',
                        timestamp: new Date().toISOString()
                    });
                },
                
                getDecisionText(decision) {
                    switch (decision) {
                        case 'approve': return '採用提案';
                        case 'reject': return '不採用';
                        case 'pending': return '保留';
                        default: return '未判定';
                    }
                },
                
                getTotalScoreClass(score) {
                    if (score >= 85) return 'score-excellent';
                    if (score >= 70) return 'score-good';
                    if (score >= 50) return 'score-fair';
                    return 'score-poor';
                },
                
                hasDecisions() {
                    return this.candidates.some(c => c.decision);
                },
                
                compareAll() {
                    const modal = new bootstrap.Modal(document.getElementById('comparisonModal'));
                    modal.show();
                },
                
                saveEvaluations() {
                    console.log('評価保存:', this.candidates);
                    alert('評価を保存しました');
                },
                
                finalizeDecisions() {
                    const approved = this.candidates.filter(c => c.decision === 'approve');
                    const rejected = this.candidates.filter(c => c.decision === 'reject');
                    const pending = this.candidates.filter(c => c.decision === 'pending');
                    
                    console.log('判定確定:', {
                        approved: approved.length,
                        rejected: rejected.length,
                        pending: pending.length
                    });
                    
                    alert(`判定を確定しました。\n採用提案: ${approved.length}名\n不採用: ${rejected.length}名\n保留: ${pending.length}名`);
                },
                
                exportComparison() {
                    console.log('比較表エクスポート');
                    alert('候補者比較表をエクスポートしました');
                },
                
                formatDate(dateStr) {
                    if (!dateStr) return '-';
                    return new Date(dateStr).toLocaleDateString('ja-JP');
                },
                
                formatDateTime(dateStr) {
                    return new Date(dateStr).toLocaleString('ja-JP');
                }
            }));
        });
    </script>
</body>
</html>