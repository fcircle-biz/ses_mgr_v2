# セキュリティ詳細設計

## 概要
本フォルダは、SES業務システムのセキュリティ詳細設計に関するドキュメントを格納しています。Keycloak、Spring Security、OAuth2/OIDCを活用した統合認証・認可システムの設計仕様を定義しています。

## フォルダ構成

### 01_Keycloak設定仕様書.md
- **内容**: Keycloak 22.xの詳細設定仕様
- **主要項目**:
  - Realm設定（ses-manager）
  - トークン設定（Access Token 5分、Refresh Token 30分）
  - Client設定（Webクライアント、各マイクロサービス）
  - ユーザー属性・プロファイル設定
  - 認証フロー設定
  - セキュリティヘッダー・CORS設定
  - Spring Boot統合設定

### 02_ロール権限マトリックス設計.md
- **内容**: ロールベースアクセス制御（RBAC）の詳細設計
- **主要項目**:
  - 8つのシステムロール定義
  - 8つのコンテキスト別権限マトリックス
  - データスコープ制御ルール
  - 特殊権限（承認フロー、データエクスポート）
  - Spring Security実装例
  - 権限チェックフロー

### 03_JWTトークン仕様.md
- **内容**: JWT（JSON Web Token）の詳細仕様
- **主要項目**:
  - トークン種別（Access/Refresh/ID/Offline）
  - 標準クレーム・カスタムクレーム定義
  - トークン検証手順
  - Spring Security実装例
  - トークン管理・ストレージ戦略
  - セキュリティ要件・エラーハンドリング

### 04_API認可ルール設計.md
- **内容**: 各マイクロサービスAPIの認可ルール詳細
- **主要項目**:
  - 8つのサービス別API認可設定
  - エンドポイント別必要権限
  - データスコープ・ビジネスルール
  - Spring Security実装例
  - 認可エラーハンドリング
  - 監査・コンプライアンス

## 技術スタック
- **認証基盤**: Keycloak 22.x LTS
- **セキュリティフレームワーク**: Spring Security 6.2.x
- **プロトコル**: OAuth 2.0, OpenID Connect 1.0
- **トークン形式**: JWT (RS256署名)
- **アクセス制御**: RBAC + ABAC

## 設計原則
1. **最小権限の原則**: 必要最小限の権限のみ付与
2. **職務分離**: 相反する業務の権限を分離
3. **Defense in Depth**: 多層防御による安全性確保
4. **Zero Trust**: 全アクセスを検証

## セキュリティ要件
- **認証強度**: パスワードポリシー（8文字以上、大小英数記号必須）
- **セッション管理**: 30分アイドルタイムアウト、10時間最大セッション
- **ブルートフォース対策**: 5回失敗で15分ロック
- **監査ログ**: 全認証・認可イベントの記録（最低1年保存）

## 実装ガイドライン
1. すべてのAPIエンドポイントに適切な`@PreAuthorize`アノテーションを付与
2. データスコープ制御は専用のSecurityServiceで実装
3. ビジネスルールは`@BusinessRule`アノテーションで宣言的に記述
4. 認可失敗は適切なエラーコード・メッセージで応答

## 関連ドキュメント
- `/doc/03_基本設計/02_アーキテクチャ設計/技術スタック設計.md`
- `/doc/04_詳細設計/01_ドメインモデル詳細設計/02_共通設計/共通例外階層設計.md`
- `/doc/04_詳細設計/02_API詳細設計/共通エラーレスポンス強化.md`

---

**作成日**: 2025年6月2日  
**最終更新**: 2025年6月2日  
**作成者**: SES業務システム開発チーム