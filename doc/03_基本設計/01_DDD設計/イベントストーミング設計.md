# イベントストーミング設計 - SES業務システム

## 1. イベントストーミングとは

### 目的
- 業務フローを時系列で可視化
- ドメインイベントの洗い出し
- ビジネスルールの発見
- チーム全体での業務理解の統一

### 参加者
- **ドメインエキスパート**: 営業担当、人事担当、経理担当、PM
- **開発チーム**: アーキテクト、開発者
- **ファシリテーター**: DDDに精通したメンバー

## 2. SES業務のドメインイベント

### 表記ルール
- **ドメインイベント**: 過去形で記述（例：案件が登録された）
- **コマンド**: 動詞形で記述（例：案件を登録する）
- **外部システム**: 紫色で記述
- **ポリシー**: 業務ルール（例：〜の場合、〜する）

## 3. 時系列ドメインイベント一覧

### 3.1 案件獲得〜受注フロー

#### フェーズ1: 案件発掘
```mermaid
sequenceDiagram
    participant 営業 as 営業担当
    participant 顧客 as 顧客
    participant システム as SESシステム
    
    顧客->>営業: 案件相談
    営業->>システム: 案件情報を登録する
    システム-->>システム: 案件が登録された
    システム-->>システム: 案件IDが採番された
    営業->>システム: 案件詳細を入力する
    システム-->>システム: 案件詳細が更新された
    
    Note over システム: ポリシー：案件登録時は自動的にリードステータスになる
```

**発生するドメインイベント:**
1. `案件相談が受領された`
2. `案件が登録された`
3. `案件IDが採番された`
4. `案件詳細が入力された`
5. `案件ステータスがリードに設定された`

#### フェーズ2: 提案・交渉
```mermaid
sequenceDiagram
    participant 営業 as 営業担当
    participant 顧客 as 顧客
    participant システム as SESシステム
    
    営業->>システム: 提案書を作成する
    システム-->>システム: 提案書が作成された
    営業->>顧客: 提案書を提出する
    システム-->>システム: 提案書が提出された
    システム-->>システム: 案件ステータスが提案中に変更された
    
    顧客->>営業: 提案に対するフィードバック
    営業->>システム: フィードバックを記録する
    システム-->>システム: 顧客フィードバックが記録された
    
    alt 提案承認の場合
        営業->>システム: 案件ステータスを交渉中に変更する
        システム-->>システム: 案件ステータスが交渉中に変更された
    else 提案却下の場合
        営業->>システム: 案件をクローズする
        システム-->>システム: 案件がクローズされた
    end
```

**発生するドメインイベント:**
6. `提案書が作成された`
7. `提案書が提出された`
8. `案件ステータスが提案中に変更された`
9. `顧客フィードバックが記録された`
10. `案件ステータスが交渉中に変更された`
11. `案件がクローズされた`

#### フェーズ3: 受注確定
```mermaid
sequenceDiagram
    participant 営業 as 営業担当
    participant 顧客 as 顧客
    participant システム as SESシステム
    
    営業->>顧客: 契約条件を交渉する
    営業->>システム: 交渉結果を記録する
    システム-->>システム: 交渉履歴が記録された
    
    alt 条件合意の場合
        営業->>システム: 受注確定を登録する
        システム-->>システム: 案件が受注された
        システム-->>システム: 案件ステータスが受注に変更された
        システム-->>システム: マッチング要求が生成された
    else 条件不一致の場合
        営業->>システム: 案件をクローズする
        システム-->>システム: 案件がクローズされた
    end
```

**発生するドメインイベント:**
12. `契約条件が交渉された`
13. `交渉履歴が記録された`
14. `案件が受注された`
15. `案件ステータスが受注に変更された`
16. `マッチング要求が生成された`

### 3.2 人材管理フロー

#### 技術者登録
```mermaid
sequenceDiagram
    participant 人事 as 人事担当
    participant 技術者 as 技術者
    participant システム as SESシステム
    
    技術者->>人事: 履歴書・職務経歴書を提出
    人事->>システム: 技術者を登録する
    システム-->>システム: 技術者が登録された
    システム-->>システム: 技術者IDが採番された
    
    人事->>システム: スキル情報を入力する
    システム-->>システム: スキル情報が登録された
    人事->>システム: 経歴情報を入力する
    システム-->>システム: 経歴情報が登録された
    
    システム->>システム: スキルシートを自動生成する
    システム-->>システム: スキルシートが生成された
    
    人事->>システム: 稼働状況を設定する
    システム-->>システム: 稼働状況が設定された
```

**発生するドメインイベント:**
17. `技術者が登録された`
18. `技術者IDが採番された`
19. `スキル情報が登録された`
20. `経歴情報が登録された`
21. `スキルシートが生成された`
22. `稼働状況が設定された`

### 3.3 マッチングフロー

```mermaid
sequenceDiagram
    participant システム as SESシステム
    participant 営業 as 営業担当
    participant 技術者 as 技術者
    participant 顧客 as 顧客
    
    Note over システム: マッチング要求を受信
    システム->>システム: マッチング処理を開始する
    システム-->>システム: マッチング処理が開始された
    
    システム->>システム: 候補者を抽出する
    システム-->>システム: 候補者が抽出された
    システム->>システム: マッチングスコアを算出する
    システム-->>システム: マッチングスコアが算出された
    
    システム->>営業: 候補者リストを提示する
    システム-->>システム: 候補者リストが提示された
    
    営業->>システム: 候補者を選定する
    システム-->>システム: 候補者が選定された
    
    営業->>顧客: 面談を設定する
    システム-->>システム: 面談が設定された
    
    顧客->>技術者: 面談を実施する
    営業->>システム: 面談結果を入力する
    システム-->>システム: 面談結果が記録された
    
    alt 面談合格の場合
        営業->>システム: マッチング成立を登録する
        システム-->>システム: マッチングが成立した
        システム-->>システム: 契約作成要求が生成された
    else 面談不合格の場合
        営業->>システム: マッチング不成立を登録する
        システム-->>システム: マッチングが不成立になった
        システム-->>システム: 再マッチング要求が生成された
    end
```

**発生するドメインイベント:**
23. `マッチング処理が開始された`
24. `候補者が抽出された`
25. `マッチングスコアが算出された`
26. `候補者リストが提示された`
27. `候補者が選定された`
28. `面談が設定された`
29. `面談結果が記録された`
30. `マッチングが成立した`
31. `契約作成要求が生成された`
32. `マッチングが不成立になった`
33. `再マッチング要求が生成された`

### 3.4 契約管理フロー

```mermaid
sequenceDiagram
    participant システム as SESシステム
    participant 営業 as 営業担当
    participant 顧客 as 顧客
    participant 技術者 as 技術者
    participant CloudSign as CloudSign
    
    Note over システム: 契約作成要求を受信
    営業->>システム: 契約条件を入力する
    システム-->>システム: 契約条件が入力された
    
    システム->>システム: 契約書を生成する
    システム-->>システム: 契約書が生成された
    システム-->>システム: 契約番号が採番された
    
    システム->>CloudSign: 電子署名を依頼する
    システム-->>システム: 電子署名が依頼された
    
    CloudSign->>顧客: 署名依頼メールを送信
    顧客->>CloudSign: 電子署名を実行
    CloudSign-->>システム: 顧客の署名が完了した
    
    CloudSign->>技術者: 署名依頼メールを送信
    技術者->>CloudSign: 電子署名を実行
    CloudSign-->>システム: 技術者の署名が完了した
    
    CloudSign->>営業: 署名依頼メールを送信
    営業->>CloudSign: 電子署名を実行
    CloudSign-->>システム: 自社の署名が完了した
    
    システム-->>システム: 契約が締結された
    システム-->>システム: プロジェクト開始準備が整った
```

**発生するドメインイベント:**
34. `契約条件が入力された`
35. `契約書が生成された`
36. `契約番号が採番された`
37. `電子署名が依頼された`
38. `顧客の署名が完了した`
39. `技術者の署名が完了した`
40. `自社の署名が完了した`
41. `契約が締結された`
42. `プロジェクト開始準備が整った`

### 3.5 勤怠・工数管理フロー

```mermaid
sequenceDiagram
    participant 技術者 as 技術者
    participant システム as SESシステム
    participant PM as PM
    participant 営業 as 営業担当
    
    loop 日次
        技術者->>システム: 勤怠を入力する
        システム-->>システム: 勤怠が入力された
    end
    
    Note over システム: 月末
    システム->>システム: 月次工数を集計する
    システム-->>システム: 月次工数が集計された
    
    システム->>PM: 承認依頼を送信する
    システム-->>システム: PM承認依頼が送信された
    
    PM->>システム: 工数を承認する
    システム-->>システム: PMが工数を承認した
    
    システム->>営業: 最終承認依頼を送信する
    システム-->>システム: 営業承認依頼が送信された
    
    営業->>システム: 工数を最終承認する
    システム-->>システム: 営業が工数を最終承認した
    システム-->>システム: 工数が確定した
    システム-->>システム: 請求処理要求が生成された
```

**発生するドメインイベント:**
43. `勤怠が入力された`
44. `月次工数が集計された`
45. `PM承認依頼が送信された`
46. `PMが工数を承認した`
47. `営業承認依頼が送信された`
48. `営業が工数を最終承認した`
49. `工数が確定した`
50. `請求処理要求が生成された`

### 3.6 請求・支払フロー

```mermaid
sequenceDiagram
    participant システム as SESシステム
    participant 経理 as 経理担当
    participant 顧客 as 顧客
    participant 技術者 as 技術者
    participant MF as マネーフォワード
    
    Note over システム: 請求処理要求を受信
    システム->>システム: 請求金額を計算する
    システム-->>システム: 請求金額が計算された
    
    システム->>システム: 請求書を生成する
    システム-->>システム: 請求書が生成された
    
    経理->>顧客: 請求書を送付する
    システム-->>システム: 請求書が送付された
    
    顧客->>経理: 代金を支払う
    経理->>システム: 入金を記録する
    システム-->>システム: 入金が記録された
    システム-->>システム: 支払処理要求が生成された
    
    システム->>システム: 支払金額を計算する
    システム-->>システム: 支払金額が計算された
    
    経理->>技術者: 支払を実行する
    システム-->>システム: 支払が実行された
    
    システム->>MF: 仕訳データを連携する
    システム-->>システム: 会計データが連携された
```

**発生するドメインイベント:**
51. `請求金額が計算された`
52. `請求書が生成された`
53. `請求書が送付された`
54. `入金が記録された`
55. `支払処理要求が生成された`
56. `支払金額が計算された`
57. `支払が実行された`
58. `会計データが連携された`

## 4. 重要なビジネスルール（ポリシー）

### 案件管理ポリシー
- **P1**: 案件登録時は自動的にリードステータスになる
- **P2**: 受注確定時にマッチング要求が自動生成される
- **P3**: 案件クローズ後30日間は再オープン可能

### マッチングポリシー
- **P4**: マッチングスコア60点以上の技術者のみ候補に表示
- **P5**: 面談不合格の場合、自動的に再マッチング要求が生成される
- **P6**: 同一技術者は同一案件に対して3回まで面談可能

### 契約管理ポリシー
- **P7**: 全当事者の電子署名完了後に契約締結とみなす
- **P8**: 契約期間満了30日前に更新確認が必要
- **P9**: 契約変更は変更契約書の締結が必要

### 工数管理ポリシー
- **P10**: 勤怠入力期限は翌月5日まで
- **P11**: PM承認後に営業承認が必要（2段階承認）
- **P12**: 承認完了後の工数変更は追加承認が必要

### 請求管理ポリシー
- **P13**: 工数確定後、自動的に請求処理が開始される
- **P14**: 入金確認後に支払処理が開始される
- **P15**: 会計システムへの仕訳データは日次バッチで連携

## 5. 次のステップ

このイベントストーミングの結果を基に：

1. **ユビキタス言語辞書の作成**
2. **境界づけられたコンテキストの詳細化**
3. **集約の設計**
4. **ドメインサービスの抽出**

を進めていきます。

---

**作成者**: システム化プロジェクトチーム