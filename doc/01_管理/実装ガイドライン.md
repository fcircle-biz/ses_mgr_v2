# SES業務システム 実装ガイドライン

**文書バージョン**: 1.0  
**作成日**: 2025年6月2日  
**最終更新**: 2025年6月2日  
**対象フェーズ**: TDD実装フェーズ

## 📋 目的

本ガイドラインは、SES業務システムの実装フェーズにおいて、**設計品質の維持**、**コード品質の統一**、**TDD原則の遵守**を確保し、高品質なソフトウェア開発を実現するための指針を定めます。

## 🚨 実装前必須確認事項

### **【重要】設計書確認の必須化**

**すべての実装作業は、必ず対応する設計書の確認から開始してください。**

#### **確認必須文書**
1. **ドメインモデル詳細設計書** (`doc/04_詳細設計/01_ドメインモデル詳細設計/`)
   - 対象集約の詳細仕様
   - ビジネスルール・制約条件
   - ドメインイベント設計
   - 例外処理設計

2. **API詳細設計書** (`doc/04_詳細設計/02_API詳細設計/`)
   - OpenAPI 3.0仕様書
   - エラーレスポンス設計
   - 認証・認可要件
   - パフォーマンス要件

3. **データベース設計書** (`doc/04_詳細設計/04_データベース詳細設計/`)
   - 物理テーブル設計
   - インデックス戦略
   - 制約・トリガー設計
   - パーティショニング設計

4. **セキュリティ設計書** (`doc/04_詳細設計/05_セキュリティ詳細設計/`)
   - 暗号化要件
   - GDPR準拠事項
   - 認証・認可設計
   - 監査ログ要件

#### **設計書確認チェックリスト**
- [ ] 対象機能の設計書を最新版で確認済み
- [ ] ビジネスルール・制約条件を理解済み
- [ ] API仕様・エラーハンドリングを確認済み
- [ ] データベーススキーマ・制約を確認済み
- [ ] セキュリティ要件・暗号化設計を確認済み
- [ ] 関連する他コンテキストとの連携仕様を確認済み
- [ ] テスト仕様・受け入れ条件を確認済み

## 🔴🟢🔵 TDD実装サイクル

### **Red-Green-Refactor原則の厳格遵守**

#### **🔴 Red: 失敗するテストを書く**
```java
@Test
void 新規プロジェクト作成時_ステータスはPLANNINGになる() {
    // Given
    String projectName = "テストプロジェクト";
    String description = "テスト用プロジェクト";
    String clientCompany = "テスト株式会社";
    
    // When
    Project project = new Project(projectName, description, clientCompany);
    
    // Then
    assertThat(project.getStatus()).isEqualTo(ProjectStatus.PLANNING);
}
```

#### **🟢 Green: テストが通る最小限のコードを書く**
```java
public class Project extends AggregateRoot {
    private ProjectStatus status;
    
    public Project(String projectName, String description, String clientCompany) {
        super();
        this.projectName = projectName;
        this.description = description;
        this.clientCompany = clientCompany;
        this.status = ProjectStatus.PLANNING; // 最小限の実装
    }
}
```

#### **🔵 Refactor: コードを改善する**
- 重複排除
- 命名改善
- 設計パターン適用
- パフォーマンス最適化

### **TDDサイクル実行ルール**
1. **1機能1サイクル**: 機能単位でRed-Green-Refactorを完結させる
2. **テストファースト**: 実装コードより先にテストを作成する
3. **最小実装**: テストを通すための最小限のコードのみ実装する
4. **継続的リファクタリング**: 各サイクルでコード品質を向上させる

## 🏗️ DDD実装アーキテクチャ

### **レイヤーアーキテクチャ**
```
Presentation Layer (REST API, DTO)
     ↓
Application Layer (Use Cases, Application Services)
     ↓
Domain Layer (Entities, Value Objects, Domain Services)
     ↓
Infrastructure Layer (Repositories, External Services)
```

### **依存関係ルール**
- **上位レイヤー → 下位レイヤー**: 依存OK
- **下位レイヤー → 上位レイヤー**: 依存禁止
- **Domain Layer**: 他レイヤーに依存禁止（純粋なビジネスロジック）
- **Infrastructure Layer**: インターフェースによる依存関係逆転

### **パッケージ構造準拠**
```
com.sesmanager.{context}/
├── domain/model/           # エンティティ・Value Objects
├── domain/repository/      # リポジトリインターフェース
├── domain/service/         # ドメインサービス
├── application/usecase/    # ユースケース実装
├── infrastructure/persistence/ # JPA実装
├── infrastructure/config/  # 設定クラス
├── presentation/api/       # REST Controller
└── presentation/dto/       # DTO・マッパー
```

## 🧪 テスト戦略

### **テストピラミッド**
```
     🔺 E2E Tests (少数・重要シナリオ)
    🔺🔺 Integration Tests (中程度・サービス連携)
  🔺🔺🔺 Unit Tests (多数・ビジネスロジック)
```

### **単体テスト (Unit Tests)**
- **対象**: ドメインロジック・ビジネスルール
- **カバレッジ**: 80%以上必須
- **フレームワーク**: JUnit 5 + AssertJ + Mockito
- **命名規則**: `対象メソッド_条件_期待結果()` (日本語OK)

### **統合テスト (Integration Tests)**
- **対象**: リポジトリ・外部サービス連携
- **フレームワーク**: TestContainers + Spring Boot Test
- **データベース**: PostgreSQL TestContainer使用
- **トランザクション**: `@Transactional` + `@Rollback`

### **E2Eテスト (End-to-End Tests)**
- **対象**: 重要業務フロー・API連携
- **フレームワーク**: REST Assured + TestContainers
- **環境**: 完全なマイクロサービス環境

## 🔒 セキュリティ実装要件

### **暗号化実装**
- **個人情報**: AES-256-GCM暗号化必須
- **共有モジュール**: `shared-security` の `EncryptionService` 使用
- **キー管理**: 環境変数・Vault連携
- **GDPR準拠**: 削除権・ポータビリティ権対応

### **認証・認可**
- **認証**: Keycloak OAuth2/OIDC
- **認可**: Spring Security + Method Security
- **トークン**: JWT Bearer Token
- **セッション**: Redis分散セッション

### **入力検証**
- **バリデーション**: Bean Validation + `shared-utils` 活用
- **サニタイゼーション**: `ValidationUtils.sanitizeInput()` 使用
- **SQLインジェクション**: JPA Criteria API・名前付きパラメータ使用

## 📊 コード品質基準

### **SonarQube品質ゲート**
- **バグ**: 0件
- **脆弱性**: 0件
- **コードスメル**: A評価
- **カバレッジ**: 80%以上
- **重複**: 3%以下

### **コーディング規約**
- **言語**: Java 17 LTS機能活用
- **フォーマット**: Google Java Style
- **命名**: 英語（ドメイン用語は日本語コメント併記）
- **コメント**: JavaDoc必須（public API）

### **パフォーマンス要件**
- **API応答時間**: 95%tile < 500ms
- **データベースクエリ**: N+1問題回避
- **メモリ使用量**: ヒープ使用率 < 70%
- **並行処理**: 同時接続500ユーザー対応

## 🔄 実装フロー

### **1. 設計書確認フェーズ**
1. **対象機能の設計書読み込み**
2. **ビジネスルール・制約条件理解**
3. **API仕様・エラーハンドリング確認**
4. **データモデル・セキュリティ要件確認**
5. **チェックリスト完了確認**

### **2. TDD実装フェーズ**
1. **🔴 Red**: 失敗テスト作成
2. **🟢 Green**: 最小実装
3. **🔵 Refactor**: コード改善
4. **統合テスト実行**
5. **品質チェック（SonarQube・Jacoco）**

### **3. レビューフェーズ**
1. **設計書整合性確認**
2. **コードレビュー（PR）**
3. **テストカバレッジ確認**
4. **セキュリティチェック**
5. **パフォーマンステスト**

### **4. 統合フェーズ**
1. **他サービス連携テスト**
2. **E2Eテスト実行**
3. **負荷テスト実行**
4. **本番デプロイ準備**

## 🚀 共有モジュール活用

### **shared-domain**
```java
// 集約ルート継承
public class Project extends AggregateRoot {
    // ドメインイベント発行
    addDomainEvent(new ProjectCreatedEvent(getId().toString()));
}

// Money Value Object使用
private Money budget = Money.ofJPY(1000000);
```

### **shared-security**
```java
// 暗号化サービス使用
@Autowired
private EncryptionService encryptionService;

public void savePersonalData(String email) {
    String encryptedEmail = encryptionService.encrypt(email, secretKey);
    // 暗号化されたメールアドレスを保存
}
```

### **shared-events**
```java
// ドメインイベント発行
@Autowired
private DomainEventPublisher eventPublisher;

public void completeProject(UUID projectId) {
    // ビジネスロジック実行
    eventPublisher.publish(new ProjectCompletedEvent(projectId.toString()));
}
```

### **shared-utils**
```java
// バリデーション活用
if (!ValidationUtils.isValidEmail(email)) {
    throw new IllegalArgumentException("無効なメールアドレス");
}

String sanitized = ValidationUtils.sanitizeInput(userInput);
```

## 📝 ドキュメント管理

### **実装中ドキュメント更新**
- **APIドキュメント**: OpenAPI 3.0自動生成
- **テストドキュメント**: テストケース・受け入れ基準
- **設計変更**: 設計書への反映・変更理由記録
- **トラブルシューティング**: 発生問題・解決方法記録

### **作業ログ管理**
- **Claude作業ログ**: `doc/98_claude_log/` 継続更新
- **実装進捗**: プロジェクト作業チェックシート更新
- **品質メトリクス**: SonarQube・Jacoco結果記録

## ⚠️ 重要な禁止事項

### **絶対に禁止**
- ❌ **設計書未確認での実装開始**
- ❌ **テストを書かずに実装コード作成**
- ❌ **ハードコーディング（設定値・認証情報）**
- ❌ **平文での個人情報保存**
- ❌ **SQL文字列結合（SQLインジェクション脆弱性）**
- ❌ **例外の握り潰し・ログ出力なし**
- ❌ **レビューなしでのマージ**
- ❌ **本番環境での直接デバッグ**

### **強く推奨しない**
- ⚠️ 設計書と異なる実装（要事前相談）
- ⚠️ 新しいライブラリ導入（要アーキテクト承認）
- ⚠️ パフォーマンス要件を満たさない実装
- ⚠️ テストカバレッジ80%未満
- ⚠️ 技術的負債の蓄積

## 🎯 成功基準

### **実装完了の定義**
- ✅ 設計書との100%整合性確認
- ✅ 単体テストカバレッジ80%以上
- ✅ 統合テスト全件合格
- ✅ SonarQube品質ゲート合格
- ✅ セキュリティチェック合格
- ✅ パフォーマンステスト合格
- ✅ コードレビュー承認
- ✅ 設計書更新（必要に応じて）

### **品質メトリクス目標**
| 項目 | 目標値 | 測定方法 |
|------|--------|----------|
| テストカバレッジ | 80%以上 | Jacoco |
| API応答時間 | 95%tile < 500ms | JMeter |
| バグ密度 | 0.1未満/KLOC | SonarQube |
| コードスメル | A評価 | SonarQube |
| セキュリティ脆弱性 | 0件 | SonarQube + OWASP |

---

## 📚 関連文書

- [基本設計方針](基本設計方針.md)
- [プロジェクト作業チェックシート](プロジェクト作業チェックシート.md)
- [UI・UX設計ガイドライン](UI・UX設計ガイドライン.md)
- [ドメインモデル詳細設計](../04_詳細設計/01_ドメインモデル詳細設計/)
- [API詳細設計](../04_詳細設計/02_API詳細設計/)

**実装作業開始前に必ずこのガイドラインを熟読し、設計書確認チェックリストを完了してから作業を開始してください。**

---

**作成者**: プロジェクトアーキテクト  
**承認者**: プロジェクトマネージャー  
**次回更新予定**: TDD実装フェーズ開始時